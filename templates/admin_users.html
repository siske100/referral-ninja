{% extends "base.html" %}

{% block title %}User Management - ReferralNinja{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Elegant Header -->
    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-4 pb-3 mb-4 border-bottom">
        <div>
            <h1 class="h3 fw-light text-dark mb-1">
                <i class="fas fa-users me-2 text-primary"></i>User Management
            </h1>
            <p class="text-muted small mb-0">Manage and monitor user accounts and activities</p>
        </div>
        <div class="btn-toolbar mb-2 mb-md-0">
            <span class="badge bg-light text-dark border me-3 px-3 py-2">
                <i class="fas fa-user me-1 text-primary"></i>Total Users: {{ users|length }}
            </span>
            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="refreshPage()">
                <i class="fas fa-sync-alt"></i>
            </button>
        </div>
    </div>

    <!-- Flash Messages -->
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
                <div class="alert alert-{{ 'danger' if category == 'error' else 'success' }} alert-dismissible fade show border-0 shadow-sm" role="alert">
                    <i class="fas fa-{{ 'exclamation-triangle' if category == 'error' else 'check-circle' }} me-2"></i>
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            {% endfor %}
        {% endif %}
    {% endwith %}

    <!-- Minimal Statistics Cards -->
    <div class="row mb-4">
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-0 shadow-sm h-100 py-3 bg-gradient-primary text-white">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-white-50 text-uppercase mb-1">
                                Total Users</div>
                            <div class="h2 mb-0 font-weight-bold">
                                {{ users|length }}
                            </div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-users fa-2x text-white-50"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-0 shadow-sm h-100 py-3">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-success text-uppercase mb-1">
                                Active Users</div>
                            <div class="h2 mb-0 font-weight-bold text-gray-800">
                                {{ users|selectattr('is_active')|list|length }}
                            </div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-user-check fa-2x text-success opacity-50"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-0 shadow-sm h-100 py-3">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-info text-uppercase mb-1">
                                Total Balance</div>
                            <div class="h2 mb-0 font-weight-bold text-gray-800">
                                Ksh {{ "%.2f"|format(users|sum(attribute='balance') or 0) }}
                            </div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-wallet fa-2x text-info opacity-50"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-0 shadow-sm h-100 py-3">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">
                                Total Referrals</div>
                            <div class="h2 mb-0 font-weight-bold text-gray-800">
                                {{ users|sum(attribute='referral_count') or 0 }}
                            </div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-share-alt fa-2x text-warning opacity-50"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Search and Filter Section - Elegant Design -->
    <div class="row mb-4">
        <div class="col-md-8">
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-body p-3">
                    <div class="input-group">
                        <span class="input-group-text bg-transparent border-0">
                            <i class="fas fa-search text-muted"></i>
                        </span>
                        <input type="text" class="form-control border-0 ps-0" id="searchInput" 
                               placeholder="Search users by name, email, phone, or referral code..." 
                               onkeyup="searchUsers()">
                        <button class="btn btn-outline-secondary border-0" type="button" onclick="clearSearch()">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-body p-3">
                    <select class="form-select border-0" id="statusFilter" onchange="filterUsers()">
                        <option value="">All Users</option>
                        <option value="active">Active Only</option>
                        <option value="inactive">Inactive Only</option>
                        <option value="admin">Admins Only</option>
                        <option value="verified">Verified Only</option>
                        <option value="unverified">Unverified Only</option>
                    </select>
                </div>
            </div>
        </div>
    </div>

    <!-- Users Table with Enhanced Elegance -->
    <div class="card border-0 shadow-sm">
        <div class="card-header bg-white py-3 border-0">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h6 class="mb-0 text-dark fw-semibold">
                        <i class="fas fa-user-friends me-2 text-primary"></i>User Directory
                    </h6>
                </div>
                <div class="d-flex align-items-center">
                    <span class="badge bg-light text-dark border me-3">
                        {{ users|selectattr('is_active')|list|length }} Active
                    </span>
                    <button class="btn btn-sm btn-outline-primary rounded-pill px-3" onclick="exportUsers()">
                        <i class="fas fa-download me-1"></i> Export
                    </button>
                </div>
            </div>
        </div>
        
        <div class="card-body p-0">
            {% if users %}
                <div class="table-responsive" style="max-height: 600px; overflow-y: auto;">
                    <table class="table table-hover mb-0" id="usersTable">
                        <thead class="bg-light">
                            <tr>
                                <th class="border-0 ps-4" style="width: 40px;">
                                    <input type="checkbox" id="selectAll" onchange="toggleSelectAll(this)">
                                </th>
                                <th class="border-0 py-3 text-dark fw-semibold">User Profile</th>
                                <th class="border-0 py-3 text-dark fw-semibold">Contact Information</th>
                                <th class="border-0 py-3 text-dark fw-semibold text-center">Performance</th>
                                <th class="border-0 py-3 text-dark fw-semibold text-center">Membership</th>
                                <th class="border-0 py-3 text-dark fw-semibold text-center">Registration</th>
                                <th class="border-0 py-3 text-dark fw-semibold text-center">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="usersTableBody">
                            {% for user in users %}
                            <tr class="user-row align-middle" 
                                data-referral="{{ user.referral_code|lower if user.referral_code else '' }}"
                                data-username="{{ user.username|lower if user.username else '' }}"
                                data-email="{{ user.email|lower if user.email else '' }}"
                                data-phone="{{ user.phone|lower if user.phone else (user.phone_number|lower if user.phone_number else '') }}"
                                data-balance="{{ user.balance|default(0) }}"
                                data-referrals="{{ user.referral_count|default(0) }}"
                                data-rank="{{ user.user_rank|lower if user.user_rank else '' }}"
                                data-joined="{{ user.created_at.strftime('%Y-%m-%d') if user.created_at and hasattr(user.created_at, 'strftime') else (user.created_at[:10] if user.created_at else '') }}"
                                data-status="{% if user.is_active %}active{% else %}inactive{% endif %} {% if user.is_admin %}admin{% endif %} {% if user.is_verified %}verified{% else %}unverified{% endif %}">
                                
                                <td class="ps-4">
                                    {% if not user.is_admin %}
                                    <input type="checkbox" class="user-checkbox" value="{{ user.id }}" onchange="updateBulkActions()">
                                    {% endif %}
                                </td>
                                
                                <td>
                                    <div class="d-flex align-items-center">
                                        <div class="flex-shrink-0">
                                            <div class="bg-primary text-white rounded-circle d-flex align-items-center justify-content-center" 
                                                 style="width: 40px; height: 40px; font-size: 14px; font-weight: 600;">
                                                {{ (user.username[0:2] if user.username else 'UU')|upper }}
                                            </div>
                                        </div>
                                        <div class="flex-grow-1 ms-3">
                                            <div class="fw-semibold text-dark username">{{ user.username or 'No username' }}</div>
                                            <div class="text-muted small">
                                                <span class="referral-code">{{ user.referral_code or 'No code' }}</span>
                                                {% if user.is_admin %}
                                                    <span class="badge bg-danger ms-1">Admin</span>
                                                {% endif %}
                                            </div>
                                            {% if user.referred_by %}
                                                <div class="text-info small">Referred by: {{ user.referred_by }}</div>
                                            {% endif %}
                                        </div>
                                    </div>
                                </td>
                                
                                <td>
                                    <div class="text-dark small fw-medium user-email">{{ user.email or 'No email' }}</div>
                                    <div class="text-muted small user-phone">{{ user.phone or (user.phone_number or 'No phone') }}</div>
                                    <div class="text-muted small">Name: {{ user.name or 'No name' }}</div>
                                </td>
                                
                                <td class="text-center">
                                    <div class="fw-bold text-success fs-6 user-balance">Ksh {{ "%.2f"|format(user.balance|default(0)) }}</div>
                                    <div class="text-muted small">Balance</div>
                                    <div class="mt-1">
                                        <span class="badge bg-info bg-opacity-10 text-info border border-info border-opacity-25 user-referrals">
                                            {{ user.referral_count|default(0) }} referrals
                                        </span>
                                    </div>
                                    <div class="mt-1">
                                        <small class="text-warning">Commission: Ksh {{ "%.2f"|format(user.total_commission|default(0)) }}</small>
                                    </div>
                                </td>
                                
                                <td class="text-center">
                                    {% if user.is_active %}
                                        <span class="badge bg-success bg-opacity-10 text-success border border-success border-opacity-25">Active</span>
                                    {% else %}
                                        <span class="badge bg-danger bg-opacity-10 text-danger border border-danger border-opacity-25">Inactive</span>
                                    {% endif %}
                                    
                                    {% if user.is_verified %}
                                        <span class="badge bg-primary bg-opacity-10 text-primary border border-primary border-opacity-25 mt-1">Verified</span>
                                    {% else %}
                                        <span class="badge bg-warning bg-opacity-10 text-warning border border-warning border-opacity-25 mt-1">Unverified</span>
                                    {% endif %}
                                    
                                    <div class="mt-1">
                                        <small class="text-muted user-rank">{{ user.user_rank or 'Bronze' }}</small>
                                    </div>
                                </td>
                                
                                <td class="text-center">
                                    <div class="text-dark small join-date">
                                        {% if user.created_at %}
                                            {% if user.created_at is string %}
                                                {{ user.created_at[:10] }}
                                            {% else %}
                                                {{ user.created_at.strftime('%Y-%m-%d') }}
                                            {% endif %}
                                        {% else %}
                                            N/A
                                        {% endif %}
                                    </div>
                                    <div class="text-muted small">
                                        {% if user.created_at %}
                                            {% if user.created_at is string %}
                                                {{ user.created_at[11:16] if user.created_at|length > 10 else '' }}
                                            {% else %}
                                                {{ user.created_at.strftime('%H:%M') }}
                                            {% endif %}
                                        {% endif %}
                                    </div>
                                    {% if user.last_login %}
                                    <div class="text-muted small">
                                        Last login: 
                                        {% if user.last_login is string %}
                                            {{ user.last_login[:10] }}
                                        {% else %}
                                            {{ user.last_login.strftime('%m/%d') }}
                                        {% endif %}
                                    </div>
                                    {% endif %}
                                </td>
                                
                                <td class="text-center">
                                    {% if not user.is_admin %}
                                        <div class="btn-group btn-group-sm">
                                            <button class="btn btn-outline-primary rounded-start-pill" 
                                                    onclick="showUserDetails('{{ user.id }}')"
                                                    title="View Details">
                                                <i class="fas fa-eye"></i>
                                            </button>
                                            <button class="btn btn-{{ 'outline-danger' if user.is_active else 'outline-success' }} rounded-end-pill" 
                                                    onclick="toggleUserStatus('{{ user.id }}')"
                                                    title="{{ 'Deactivate' if user.is_active else 'Activate' }}">
                                                <i class="fas fa-{{ 'user-slash' if user.is_active else 'user-check' }}"></i>
                                            </button>
                                        </div>
                                        <div class="mt-1">
                                            {% if not user.is_verified %}
                                                <button class="btn btn-outline-warning btn-sm rounded-pill" 
                                                        onclick="verifyUser('{{ user.id }}')"
                                                        title="Verify User">
                                                    <i class="fas fa-check-circle"></i> Verify
                                                </button>
                                            {% endif %}
                                        </div>
                                    {% else %}
                                        <span class="text-muted small">Admin Account</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                
                <!-- No Results Message -->
                <div id="noResults" class="text-center py-5" style="display: none;">
                    <div class="py-4">
                        <i class="fas fa-search fa-2x text-muted mb-3 opacity-50"></i>
                        <h6 class="text-muted mb-2">No users found</h6>
                        <p class="text-muted small mb-3">Try adjusting your search criteria</p>
                        <button class="btn btn-sm btn-outline-primary rounded-pill px-3" onclick="clearAllFilters()">
                            Clear Filters
                        </button>
                    </div>
                </div>
                
                <!-- Elegant Pagination -->
                <div class="d-flex justify-content-between align-items-center p-4 border-top bg-light">
                    <div class="text-muted small">
                        Showing <span id="showingCount">{{ users|length if users|length < 10 else 10 }}</span> of <span id="totalCount">{{ users|length }}</span> users
                    </div>
                    <nav>
                        <ul class="pagination mb-0" id="paginationControls">
                            <!-- Pagination will be generated by JavaScript -->
                        </ul>
                    </nav>
                </div>
            {% else %}
                <div class="text-center py-5">
                    <i class="fas fa-users fa-3x text-muted mb-3 opacity-50"></i>
                    <h6 class="text-muted">No users found in the system</h6>
                    <p class="text-muted small">Users will appear here once they register</p>
                </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Enhanced User Detail Modal -->
<div class="modal fade" id="userDetailModal" tabindex="-1" aria-labelledby="userDetailModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content border-0 shadow">
            <div class="modal-header bg-light border-0 py-4">
                <h5 class="modal-title text-dark fw-semibold" id="userDetailModalLabel">
                    <i class="fas fa-user-circle me-2 text-primary"></i>User Profile
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-0" id="userDetailContent">
                <!-- User details will be loaded here -->
            </div>
        </div>
    </div>
</div>

<!-- User Verification Modal -->
<div class="modal fade" id="verifyUserModal" tabindex="-1" aria-labelledby="verifyUserModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content border-0 shadow">
            <div class="modal-header bg-warning border-0 py-3">
                <h5 class="modal-title text-dark fw-semibold" id="verifyUserModalLabel">
                    <i class="fas fa-user-check me-2"></i>Verify User
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to verify this user? This will grant them full access to the platform.</p>
                <div class="alert alert-info border-0 small">
                    <i class="fas fa-info-circle me-2"></i>
                    Verified users can access all features including withdrawals and referrals.
                </div>
            </div>
            <div class="modal-footer border-0">
                <button type="button" class="btn btn-outline-secondary rounded-pill px-4" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-warning rounded-pill px-4" id="confirmVerifyBtn">Verify User</button>
            </div>
        </div>
    </div>
</div>

<!-- Loading Spinner -->
<div id="loadingSpinner" class="d-none position-fixed top-0 start-0 w-100 h-100 d-flex align-items-center justify-content-center" style="background: rgba(255,255,255,0.8); z-index: 9999;">
    <div class="text-center">
        <div class="spinner-border text-primary mb-3" role="status" style="width: 3rem; height: 3rem;">
            <span class="visually-hidden">Loading...</span>
        </div>
        <p class="text-muted">Loading...</p>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Global variables
let currentPage = 1;
const usersPerPage = 10;
let currentUserId = null;

// CSRF Token handling
function getCSRFToken() {
    const metaTag = document.querySelector('meta[name="csrf-token"]');
    return metaTag ? metaTag.getAttribute('content') : '';
}

// Enhanced admin request function with CSRF protection
const adminRequest = (url, options = {}) => {
    const defaultOptions = {
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCSRFToken()
        }
    };
    
    // Ensure we're using absolute URLs for API calls
    const fullUrl = url.startsWith('/') ? url : `/admin/${url}`;
    
    return fetch(fullUrl, {...defaultOptions, ...options});
};

function refreshPage() {
    showLoading();
    window.location.reload();
}

function showLoading() {
    document.getElementById('loadingSpinner').classList.remove('d-none');
}

function hideLoading() {
    document.getElementById('loadingSpinner').classList.add('d-none');
}

// Enhanced search with multiple criteria
function searchUsers() {
    const searchTerm = document.getElementById('searchInput').value.toLowerCase();
    const statusFilter = document.getElementById('statusFilter').value;
    const rows = document.querySelectorAll('#usersTableBody .user-row');
    let visibleCount = 0;

    rows.forEach(row => {
        const referral = row.getAttribute('data-referral') || '';
        const username = row.getAttribute('data-username') || '';
        const email = row.getAttribute('data-email') || '';
        const phone = row.getAttribute('data-phone') || '';
        const status = row.getAttribute('data-status') || '';

        // Check if row matches search term (multiple fields)
        const matchesSearch = searchTerm === '' || 
            referral.includes(searchTerm) ||
            username.includes(searchTerm) ||
            email.includes(searchTerm) ||
            phone.includes(searchTerm);

        // Check if row matches status filter
        const matchesStatus = statusFilter === '' || 
            (statusFilter === 'active' && status.includes('active')) ||
            (statusFilter === 'inactive' && status.includes('inactive')) ||
            (statusFilter === 'admin' && status.includes('admin')) ||
            (statusFilter === 'verified' && status.includes('verified')) ||
            (statusFilter === 'unverified' && status.includes('unverified'));

        if (matchesSearch && matchesStatus) {
            row.style.display = '';
            visibleCount++;
            
            // Highlight matching text if search term is not empty
            if (searchTerm !== '') {
                highlightMatchingText(row, searchTerm);
            }
        } else {
            row.style.display = 'none';
            removeHighlighting(row);
        }
    });

    // Update counts and pagination
    updateUserCounts(visibleCount);
    updatePagination(visibleCount);
    
    // Show/hide no results message
    toggleNoResultsMessage(visibleCount);
}

function highlightMatchingText(row, searchTerm) {
    const elementsToHighlight = [
        row.querySelector('.username'),
        row.querySelector('.user-email'),
        row.querySelector('.user-phone'),
        row.querySelector('.referral-code')
    ];
    
    elementsToHighlight.forEach(element => {
        if (element) {
            const originalText = element.textContent;
            const lowerOriginal = originalText.toLowerCase();
            const lowerSearch = searchTerm.toLowerCase();
            
            if (lowerOriginal.includes(lowerSearch)) {
                const index = lowerOriginal.indexOf(lowerSearch);
                const highlightedText = 
                    originalText.substring(0, index) +
                    '<mark class="bg-warning bg-opacity-25 px-1 rounded">' + 
                    originalText.substring(index, index + searchTerm.length) + 
                    '</mark>' +
                    originalText.substring(index + searchTerm.length);
                element.innerHTML = highlightedText;
            }
        }
    });
}

function removeHighlighting(row) {
    const elements = row.querySelectorAll('mark');
    elements.forEach(element => {
        const parent = element.parentNode;
        parent.replaceChild(document.createTextNode(element.textContent), element);
        parent.normalize();
    });
}

function clearSearch() {
    document.getElementById('searchInput').value = '';
    searchUsers();
}

function clearAllFilters() {
    clearSearch();
    document.getElementById('statusFilter').value = '';
    searchUsers();
}

function filterUsers() {
    searchUsers();
}

// Bulk Actions Functions
function toggleSelectAll(checkbox) {
    const checkboxes = document.querySelectorAll('.user-checkbox');
    checkboxes.forEach(cb => {
        if (!cb.disabled) {
            cb.checked = checkbox.checked;
        }
    });
    updateBulkActions();
}

function getSelectedUserIds() {
    const checkboxes = document.querySelectorAll('.user-checkbox:checked');
    return Array.from(checkboxes).map(cb => cb.value);
}

function updateBulkActions() {
    const selectedCount = getSelectedUserIds().length;
    // You can add bulk action buttons here if needed
}

// User Management Functions
function toggleUserStatus(userId) {
    const action = confirm('Are you sure you want to change this user\'s status?');
    if (action) {
        showLoading();
        adminRequest(`toggle-user-status/${userId}`, {
            method: 'POST'
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            return response.json();
        })
        .then(data => {
            hideLoading();
            if (data.success) {
                showNotification('success', data.message || 'User status updated successfully');
                // Refresh the page after a short delay to show updated data
                setTimeout(() => {
                    window.location.reload();
                }, 1500);
            } else {
                showNotification('error', data.message || 'Error updating user status');
            }
        })
        .catch(error => {
            hideLoading();
            console.error('Error:', error);
            showNotification('error', 'An error occurred while updating user status: ' + error.message);
        });
    }
}

function verifyUser(userId) {
    currentUserId = userId;
    const modal = new bootstrap.Modal(document.getElementById('verifyUserModal'));
    modal.show();
}

// Setup verify button event listener
document.addEventListener('DOMContentLoaded', function() {
    document.getElementById('confirmVerifyBtn').addEventListener('click', function() {
        if (currentUserId) {
            showLoading();
            // For now, just show a message since the backend route doesn't exist
            hideLoading();
            showNotification('warning', 'User verification feature is not yet implemented in the backend');
            bootstrap.Modal.getInstance(document.getElementById('verifyUserModal')).hide();
            /*
            // Uncomment when backend route is implemented
            adminRequest(`verify-user/${currentUserId}`, {
                method: 'POST'
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                hideLoading();
                if (data.success) {
                    showNotification('success', data.message || 'User verified successfully');
                    bootstrap.Modal.getInstance(document.getElementById('verifyUserModal')).hide();
                    setTimeout(() => location.reload(), 1500);
                } else {
                    showNotification('error', data.message || 'Error verifying user');
                }
            })
            .catch(error => {
                hideLoading();
                console.error('Error:', error);
                showNotification('error', 'An error occurred while verifying user');
            });
            */
        }
    });
});

function showUserDetails(userId) {
    showLoading();
    // For now, show basic user info from the table since the backend route doesn't exist
    const row = document.querySelector(`.user-row [data-user-id="${userId}"]`)?.closest('.user-row');
    if (row) {
        const username = row.querySelector('.username').textContent;
        const email = row.querySelector('.user-email').textContent;
        const phone = row.querySelector('.user-phone').textContent;
        const balance = row.querySelector('.user-balance').textContent;
        const referrals = row.querySelector('.user-referrals').textContent;
        const joinDate = row.querySelector('.join-date').textContent;
        
        const modalContent = document.getElementById('userDetailContent');
        modalContent.innerHTML = `
            <div class="p-4">
                <div class="alert alert-info border-0">
                    <i class="fas fa-info-circle me-2"></i>
                    Detailed user view is not yet implemented. Showing basic information.
                </div>
                <div class="row">
                    <div class="col-md-6">
                        <h6>Basic Information</h6>
                        <p><strong>Username:</strong> ${username}</p>
                        <p><strong>Email:</strong> ${email}</p>
                        <p><strong>Phone:</strong> ${phone}</p>
                    </div>
                    <div class="col-md-6">
                        <h6>Account Information</h6>
                        <p><strong>Balance:</strong> ${balance}</p>
                        <p><strong>Referrals:</strong> ${referrals}</p>
                        <p><strong>Joined:</strong> ${joinDate}</p>
                    </div>
                </div>
            </div>
            <div class="modal-footer bg-light border-0">
                <button type="button" class="btn btn-outline-secondary rounded-pill px-4" data-bs-dismiss="modal">Close</button>
            </div>
        `;
        hideLoading();
        const modal = new bootstrap.Modal(document.getElementById('userDetailModal'));
        modal.show();
    } else {
        hideLoading();
        showNotification('error', 'Could not find user details');
    }
    
    /*
    // Uncomment when backend route is implemented
    adminRequest(`user-details/${userId}`)
        .then(response => {
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            return response.json();
        })
        .then(user => {
            hideLoading();
            // ... existing user details code ...
        })
        .catch(error => {
            hideLoading();
            console.error('Error:', error);
            showNotification('error', 'Failed to load user details: ' + error.message);
        });
    */
}

// Export Functionality
function exportUsers() {
    const visibleRows = document.querySelectorAll('#usersTableBody .user-row:not([style*="display: none"])');
    
    if (visibleRows.length === 0) {
        showNotification('warning', 'No users to export');
        return;
    }
    
    let csv = 'Username,Email,Phone,Name,Referral Code,Status,Verified,Rank,Balance,Total Commission,Referrals,Joined Date,Referred By,User Rank\n';
    
    visibleRows.forEach(row => {
        const username = (row.querySelector('.username')?.textContent || '').trim().replace(/"/g, '""');
        const email = (row.querySelector('.user-email')?.textContent || '').trim().replace(/"/g, '""');
        const phone = (row.querySelector('.user-phone')?.textContent || '').trim().replace(/"/g, '""');
        const nameElement = row.querySelector('.text-muted.small'); // Assuming name is in this format
        const name = (nameElement?.textContent?.replace('Name: ', '') || '').trim().replace(/"/g, '""');
        const referralCode = (row.querySelector('.referral-code')?.textContent || '').trim().replace(/"/g, '""');
        
        // Extract status information
        const statusBadge = row.querySelector('.badge.bg-success, .badge.bg-danger');
        const status = statusBadge ? statusBadge.textContent.trim() : 'Unknown';
        const isVerified = row.querySelector('.badge.bg-primary') ? 'Yes' : 'No';
        const rank = (row.querySelector('.user-rank')?.textContent || '').trim();
        const balance = (row.querySelector('.user-balance')?.textContent?.replace('Ksh ', '') || '0').trim();
        const referrals = (row.querySelector('.user-referrals')?.textContent?.replace(' referrals', '') || '0').trim();
        const joinedDate = (row.querySelector('.join-date')?.textContent || '').trim();
        const referredBy = row.querySelector('.text-info') ? 
            row.querySelector('.text-info').textContent.replace('Referred by: ', '').trim().replace(/"/g, '""') : '';
        const userRank = rank;
        
        // Extract commission if available
        const commissionElement = row.querySelector('.text-warning');
        const totalCommission = commissionElement ? 
            commissionElement.textContent.replace('Commission: Ksh ', '').trim() : '0';
        
        csv += `"${username}","${email}","${phone}","${name}","${referralCode}","${status}","${isVerified}","${rank}","${balance}","${totalCommission}","${referrals}","${joinedDate}","${referredBy}","${userRank}"\n`;
    });
    
    // Create and download CSV file
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.setAttribute('hidden', '');
    a.setAttribute('href', url);
    a.setAttribute('download', `users_export_${new Date().toISOString().split('T')[0]}.csv`);
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    window.URL.revokeObjectURL(url);
    
    showNotification('success', `Exported ${visibleRows.length} users successfully!`);
}

// Pagination Functions
function updatePagination(totalUsers) {
    const totalPages = Math.ceil(totalUsers / usersPerPage);
    const paginationContainer = document.getElementById('paginationControls');
    
    if (totalPages <= 1) {
        paginationContainer.innerHTML = '';
        return;
    }
    
    let paginationHTML = '';
    
    // Previous button
    paginationHTML += `
        <li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
            <a class="page-link border-0 rounded-start-pill" href="#" onclick="changePage(${currentPage - 1})">
                <i class="fas fa-chevron-left"></i>
            </a>
        </li>
    `;
    
    // Page numbers
    for (let i = 1; i <= totalPages; i++) {
        if (i === 1 || i === totalPages || (i >= currentPage - 1 && i <= currentPage + 1)) {
            paginationHTML += `
                <li class="page-item ${i === currentPage ? 'active' : ''}">
                    <a class="page-link border-0 ${i === currentPage ? 'bg-primary' : ''}" href="#" onclick="changePage(${i})">${i}</a>
                </li>
            `;
        } else if (i === currentPage - 2 || i === currentPage + 2) {
            paginationHTML += `<li class="page-item disabled"><span class="page-link border-0">...</span></li>`;
        }
    }
    
    // Next button
    paginationHTML += `
        <li class="page-item ${currentPage === totalPages ? 'disabled' : ''}">
            <a class="page-link border-0 rounded-end-pill" href="#" onclick="changePage(${currentPage + 1})">
                <i class="fas fa-chevron-right"></i>
            </a>
        </li>
    `;
    
    paginationContainer.innerHTML = paginationHTML;
}

function changePage(page) {
    currentPage = page;
    document.querySelector('.table-responsive').scrollTop = 0;
    updateDisplayedUsers();
}

function updateDisplayedUsers() {
    const rows = document.querySelectorAll('#usersTableBody .user-row:not([style*="display: none"])');
    const startIndex = (currentPage - 1) * usersPerPage;
    const endIndex = startIndex + usersPerPage;
    
    rows.forEach((row, index) => {
        if (index >= startIndex && index < endIndex) {
            row.style.display = '';
        } else {
            row.style.display = 'none';
        }
    });
    
    updateUserCounts(rows.length);
}

function updateUserCounts(visibleCount) {
    const startIndex = (currentPage - 1) * usersPerPage + 1;
    const endIndex = Math.min(startIndex + usersPerPage - 1, visibleCount);
    document.getElementById('showingCount').textContent = 
        visibleCount > 0 ? `${startIndex}-${endIndex}` : '0';
    document.getElementById('totalCount').textContent = visibleCount;
}

function toggleNoResultsMessage(visibleCount) {
    const noResults = document.getElementById('noResults');
    const table = document.querySelector('.table-responsive');
    const pagination = document.querySelector('.d-flex.justify-content-between');
    
    if (visibleCount === 0 && document.querySelectorAll('.user-row').length > 0) {
        noResults.style.display = 'block';
        table.style.display = 'none';
        if (pagination) pagination.style.display = 'none';
    } else {
        noResults.style.display = 'none';
        table.style.display = 'block';
        if (pagination) pagination.style.display = 'flex';
    }
}

// Utility Functions
function showNotification(type, message) {
    // Remove existing notifications
    const existingAlerts = document.querySelectorAll('.alert.position-fixed');
    existingAlerts.forEach(alert => alert.remove());
    
    // Create notification element
    const notification = document.createElement('div');
    notification.className = `alert alert-${type} alert-dismissible fade show position-fixed border-0 shadow`;
    notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    notification.innerHTML = `
        <i class="fas fa-${getNotificationIcon(type)} me-2"></i>
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(notification);
    
    // Auto remove after 5 seconds
    setTimeout(() => {
        if (notification.parentNode) {
            notification.parentNode.removeChild(notification);
        }
    }, 5000);
}

function getNotificationIcon(type) {
    const icons = {
        'success': 'check-circle',
        'error': 'exclamation-triangle',
        'warning': 'exclamation-circle',
        'info': 'info-circle'
    };
    return icons[type] || 'info-circle';
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    // Add event listener for Enter key in search
    document.getElementById('searchInput').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            searchUsers();
        }
    });
    
    // Initialize pagination and display
    const totalUsers = {{ users|length }};
    updatePagination(totalUsers);
    updateDisplayedUsers();
    updateUserCounts(totalUsers);
    
    // Initial search to set up highlighting and counts
    searchUsers();
    
    // Debug: Log users data
    console.log('Total users loaded:', totalUsers);
});
</script>

<style>
/* Enhanced Elegant Styling */
.card {
    border-radius: 12px;
}

.btn {
    border-radius: 8px;
}

.badge {
    border-radius: 6px;
    font-weight: 500;
}

.table th {
    font-weight: 600;
    font-size: 0.85rem;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.table td {
    padding: 1rem 0.75rem;
    border-bottom: 1px solid #f0f0f0;
}

.table tbody tr:last-child td {
    border-bottom: none;
}

.table tbody tr:hover {
    background-color: #f8fafc;
    transform: translateY(-1px);
    transition: all 0.2s ease;
    box-shadow: 0 2px 8px rgba(0,0,0,0.05);
}

.bg-gradient-primary {
    background: linear-gradient(135deg, #4f46e5 0%, #7c73e6 100%) !important;
}

/* Custom scrollbar for table */
.table-responsive::-webkit-scrollbar {
    width: 6px;
    height: 6px;
}

.table-responsive::-webkit-scrollbar-track {
    background: #f1f1f1;
    border-radius: 10px;
}

.table-responsive::-webkit-scrollbar-thumb {
    background: #c1c1c1;
    border-radius: 10px;
}

.table-responsive::-webkit-scrollbar-thumb:hover {
    background: #a8a8a8;
}

/* Loading animation */
@keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}

.user-row {
    animation: fadeIn 0.3s ease-out;
}

/* Modal enhancements */
.modal-content {
    border-radius: 16px;
}

.modal-header {
    border-radius: 16px 16px 0 0;
}

/* Input group enhancements */
.input-group:focus-within {
    box-shadow: 0 0 0 2px rgba(79, 70, 229, 0.1);
    border-radius: 8px;
}

/* Pagination styling */
.page-link {
    border: none !important;
    margin: 0 2px;
    border-radius: 8px !important;
}

.page-link:hover {
    background-color: #f8f9fa;
}

.page-item.active .page-link {
    background-color: #4f46e5;
    border-color: #4f46e5;
}

/* Badge enhancements */
.badge {
    font-size: 0.75em;
    padding: 0.35em 0.65em;
}

/* Table header sticky enhancement */
.table thead th {
    position: sticky;
    top: 0;
    background: #f8f9fa;
    z-index: 10;
    border-bottom: 2px solid #e9ecef;
}

/* Custom checkbox styling */
.form-check-input:checked {
    background-color: #4f46e5;
    border-color: #4f46e5;
}

/* Smooth transitions */
.card, .btn, .badge, .table tbody tr {
    transition: all 0.3s ease;
}

/* Bronze rank color */
.bg-brown {
    background-color: #cd7f32 !important;
    color: white !important;
}
</style>
{% endblock %}
