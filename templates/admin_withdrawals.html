{% extends "base.html" %}

{% block title %}Admin Withdrawal Management - Referral Ninja{% endblock %}

{% block content %}
<!-- ADMIN WITHDRAWAL MANAGEMENT CONTENT -->
<div class="dashboard-container">
    <!-- Dashboard Header -->
    <div class="dashboard-header">
        <div class="d-flex justify-content-between align-items-center flex-column flex-md-row">
            <div class="text-center text-md-start mb-2 mb-md-0">
                <h1 class="page-title">Withdrawal Management</h1>
                <p class="page-subtitle">Monitor and process user withdrawal requests with fraud detection</p>
            </div>
            <div class="mt-2 mt-md-0">
                <span class="live-indicator" id="liveIndicator">Live Updates</span>
                <span class="connection-status ms-2" id="connectionStatus" style="display: none;"></span>
            </div>
        </div>
    </div>

    <!-- Stats Overview -->
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-value" id="total-pending">0</div>
            <div class="stat-label">Pending Withdrawals</div>
            <i class="fas fa-clock stat-icon"></i>
        </div>
        <div class="stat-card">
            <div class="stat-value" id="total-amount">KES 0</div>
            <div class="stat-label">Total Pending Amount</div>
            <i class="fas fa-wallet stat-icon"></i>
        </div>
        <div class="stat-card">
            <div class="stat-value" id="under-review">0</div>
            <div class="stat-label">Under Review</div>
            <i class="fas fa-search stat-icon"></i>
        </div>
        <div class="stat-card">
            <div class="stat-value" id="processing">0</div>
            <div class="stat-label">Processing</div>
            <i class="fas fa-cog stat-icon"></i>
        </div>
    </div>

    <!-- Bulk Actions Section -->
    <div class="bulk-actions">
        <h3>Bulk Actions</h3>
        <p class="text-muted">Select multiple withdrawals and process them in bulk</p>
        
        <div class="d-flex flex-wrap gap-2 mb-3">
            <button class="btn btn-success flex-fill" onclick="bulkApprove()">
                <i class="fas fa-check-circle me-2"></i>Approve Selected
            </button>
            <button class="btn btn-danger flex-fill" onclick="bulkReject()">
                <i class="fas fa-times-circle me-2"></i>Reject Selected
            </button>
            <button class="btn btn-warning flex-fill" onclick="bulkMarkUnderReview()">
                <i class="fas fa-search me-2"></i>Mark as Under Review
            </button>
            <button class="btn btn-outline-secondary flex-fill" onclick="clearSelection()">
                <i class="fas fa-times me-2"></i>Clear Selection
            </button>
        </div>
        <div class="form-check">
            <input class="form-check-input" type="checkbox" id="selectAll">
            <label class="form-check-label" for="selectAll">
                Select all withdrawals on this page
            </label>
        </div>
    </div>

    <!-- Withdrawals Table -->
    <div class="card">
        <div class="card-header d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center">
            <span class="mb-2 mb-md-0">Withdrawal Requests</span>
            <div class="d-flex gap-2">
                <button class="btn btn-sm btn-outline-secondary" onclick="refreshWithdrawals()">
                    <i class="fas fa-sync-alt"></i> <span class="d-none d-md-inline">Refresh</span>
                </button>
                <button class="btn btn-sm btn-primary" onclick="exportWithdrawalData()">
                    <i class="fas fa-download"></i> <span class="d-none d-md-inline">Export Data</span>
                </button>
            </div>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>
                                <input type="checkbox" class="bulk-checkbox" id="selectAllHeader">
                            </th>
                            <th>User</th>
                            <th>Amount</th>
                            <th class="d-none d-md-table-cell">Phone</th>
                            <th>Status</th>
                            <th class="d-none d-md-table-cell">Date</th>
                            <th>Days</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="withdrawals-table">
                        <tr>
                            <td colspan="8" class="text-center py-4">
                                <div class="loading-spinner"></div>
                                Loading withdrawal data...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
            
            <!-- Pagination -->
            <nav aria-label="Withdrawal pagination" id="pagination-container" style="display: none;">
                <ul class="pagination justify-content-center">
                    <li class="page-item disabled" id="prev-page">
                        <a class="page-link" href="#" tabindex="-1">Previous</a>
                    </li>
                    <li class="page-item active"><a class="page-link" href="#">1</a></li>
                    <li class="page-item" id="next-page">
                        <a class="page-link" href="#">Next</a>
                    </li>
                </ul>
            </nav>
        </div>
    </div>

    <!-- Fraud Monitoring Section -->
    <div class="card mt-4">
        <div class="card-header">
            <span>Fraud Detection & Security Alerts</span>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-12 col-md-6 mb-3 mb-md-0">
                    <h5>Suspicious Activity</h5>
                    <div id="suspicious-activity">
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>
                            Loading fraud detection data...
                        </div>
                    </div>
                </div>
                <div class="col-12 col-md-6">
                    <h5>Security Events</h5>
                    <div id="security-events">
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>
                            Loading security events...
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- END ADMIN WITHDRAWAL MANAGEMENT CONTENT -->

<!-- Withdrawal Details Modal -->
<div class="modal fade withdrawal-details-modal" id="withdrawalDetailsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Withdrawal Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="withdrawalDetailsContent">
                <div class="text-center py-4">
                    <div class="loading-spinner"></div>
                    Loading withdrawal details...
                </div>
            </div>
            <div class="modal-footer d-flex flex-column flex-sm-row">
                <button type="button" class="btn btn-secondary mb-2 mb-sm-0 flex-fill" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary mb-2 mb-sm-0 flex-fill" id="approveBtn" style="display: none;">Approve & Process</button>
                <button type="button" class="btn btn-danger flex-fill" id="rejectBtn" style="display: none;">Reject & Refund</button>
            </div>
        </div>
    </div>
</div>

<!-- Confirmation Modal -->
<div class="modal fade" id="confirmationModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="confirmationTitle">Confirm Action</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="confirmationMessage">
                Are you sure you want to proceed?
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="confirmActionBtn">Confirm</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block styles %}
<style>
/* ===== ADMIN WITHDRAWAL MANAGEMENT STYLES ===== */
.dashboard-container {
    max-width: 1400px;
    margin: 0 auto;
}

/* Header Styles */
.dashboard-header {
    margin-bottom: 2rem;
    padding-bottom: 1.5rem;
    border-bottom: 1px solid var(--border-light);
}

.page-title {
    font-weight: 700;
    color: var(--text-dark);
    margin-bottom: 0.5rem;
    font-size: clamp(1.5rem, 4vw, 2rem);
}

.page-subtitle {
    color: var(--text-light);
    font-size: clamp(0.9rem, 2.5vw, 1.1rem);
}

/* Stats Cards */
.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
    gap: 1.5rem;
    margin-bottom: 2rem;
}

.stat-card {
    background: var(--card-bg);
    border-radius: var(--radius-lg);
    padding: 1.5rem;
    box-shadow: var(--shadow-md);
    transition: all 0.3s ease;
    border-left: 4px solid var(--primary-dark);
    position: relative;
    overflow: hidden;
}

.stat-card:hover {
    transform: translateY(-5px);
    box-shadow: var(--shadow-xl);
}

.stat-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 4px;
    background: var(--primary-gradient);
}

.stat-value {
    font-size: clamp(1.8rem, 5vw, 2.5rem);
    font-weight: 700;
    margin-bottom: 0.5rem;
    background: var(--primary-gradient);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
}

.stat-label {
    color: var(--text-light);
    font-weight: 500;
    font-size: 0.95rem;
}

.stat-icon {
    position: absolute;
    top: 1.5rem;
    right: 1.5rem;
    font-size: clamp(1.5rem, 4vw, 2rem);
    opacity: 0.2;
    color: var(--primary-dark);
}

/* Live Updates Indicator */
.live-indicator {
    display: inline-flex;
    align-items: center;
    background: rgba(56, 161, 105, 0.1);
    color: var(--success);
    padding: 0.25rem 0.75rem;
    border-radius: 50px;
    font-size: 0.75rem;
    font-weight: 600;
    margin-left: 1rem;
}

.live-indicator::before {
    content: '';
    width: 8px;
    height: 8px;
    background: var(--success);
    border-radius: 50%;
    margin-right: 0.5rem;
    animation: pulse 2s infinite;
}

@keyframes pulse {
    0% {
        box-shadow: 0 0 0 0 rgba(56, 161, 105, 0.7);
    }
    70% {
        box-shadow: 0 0 0 10px rgba(56, 161, 105, 0);
    }
    100% {
        box-shadow: 0 0 0 0 rgba(56, 161, 105, 0);
    }
}

/* Status Badges */
.badge {
    padding: 0.5rem 0.75rem;
    border-radius: var(--radius-sm);
    font-weight: 600;
    font-size: 0.75rem;
}

.badge-success {
    background: rgba(56, 161, 105, 0.1);
    color: var(--success);
}

.badge-warning {
    background: rgba(214, 158, 46, 0.1);
    color: var(--warning);
}

.badge-danger {
    background: rgba(229, 62, 62, 0.1);
    color: var(--danger);
}

.badge-info {
    background: rgba(49, 130, 206, 0.1);
    color: var(--info);
}

.badge-secondary {
    background: rgba(113, 128, 150, 0.1);
    color: var(--text-light);
}

/* Admin-specific styles */
.bulk-actions {
    background: var(--card-bg);
    border-radius: var(--radius-lg);
    padding: 1.5rem;
    box-shadow: var(--shadow-md);
    margin-bottom: 2rem;
}

.withdrawal-details-modal .modal-content {
    border-radius: var(--radius-lg);
    border: none;
    box-shadow: var(--shadow-xl);
}

.fraud-alert {
    background: linear-gradient(135deg, #fed7d7, #feb2b2);
    border-left: 4px solid var(--danger);
    padding: 1rem;
    border-radius: var(--radius-md);
    margin-bottom: 1rem;
}

.user-details-card {
    background: rgba(102, 126, 234, 0.05);
    border-radius: var(--radius-md);
    padding: 1rem;
    margin-bottom: 1rem;
}

.action-buttons {
    display: flex;
    gap: 0.5rem;
    flex-wrap: wrap;
}

.bulk-checkbox {
    width: 20px;
    height: 20px;
}

.table th:first-child,
.table td:first-child {
    width: 40px;
}

.fraud-warning {
    background: rgba(229, 62, 62, 0.1);
    border-left: 3px solid var(--danger);
    padding: 0.5rem;
    border-radius: var(--radius-sm);
    margin-top: 0.5rem;
    font-size: 0.8rem;
}

.connection-status {
    display: inline-flex;
    align-items: center;
    padding: 0.25rem 0.75rem;
    border-radius: 50px;
    font-size: 0.75rem;
    font-weight: 600;
}

.connection-status.online {
    background: rgba(56, 161, 105, 0.1);
    color: var(--success);
}

.connection-status.offline {
    background: rgba(229, 62, 62, 0.1);
    color: var(--danger);
}

.connection-status i {
    margin-right: 0.5rem;
}

.loading-spinner {
    width: 40px;
    height: 40px;
    border: 4px solid #f3f3f3;
    border-top: 4px solid var(--primary);
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin: 0 auto;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

/* Responsive Design for Admin Withdrawal Management */
@media (max-width: 768px) {
    .bulk-actions .d-flex {
        flex-direction: column;
    }

    .bulk-actions .btn {
        width: 100%;
    }

    .table th:nth-child(4),
    .table td:nth-child(4),
    .table th:nth-child(6),
    .table td:nth-child(6) {
        display: none;
    }

    .action-buttons {
        flex-direction: column;
    }

    .stats-grid {
        grid-template-columns: 1fr;
    }
}

@media (min-width: 768px) and (max-width: 992px) {
    .stats-grid {
        grid-template-columns: repeat(2, 1fr);
    }
}

@media (max-width: 576px) {
    .bulk-actions {
        padding: 1rem;
    }
    
    .stat-card {
        padding: 1rem;
    }
    
    .modal-footer {
        flex-direction: column;
    }
    
    .modal-footer .btn {
        margin-bottom: 0.5rem;
    }
}

/* High DPI Screens */
@media (-webkit-min-device-pixel-ratio: 2), (min-resolution: 192dpi) {
    .stat-card {
        box-shadow: 0 2px 20px rgba(0,0,0,0.1);
    }
}

/* Orientation Specific */
@media (orientation: landscape) and (max-height: 500px) {
    .stats-grid {
        grid-template-columns: repeat(4, 1fr);
        gap: 1rem;
    }
    
    .stat-card {
        padding: 1rem;
    }
}

/* Print Styles */
@media print {
    .bulk-actions,
    .action-buttons,
    .live-indicator {
        display: none !important;
    }
    
    .stat-card {
        break-inside: avoid;
    }
}
</style>
{% endblock %}

{% block scripts %}
<script>
    // DOM Elements
    const totalPendingEl = document.getElementById('total-pending');
    const totalAmountEl = document.getElementById('total-amount');
    const underReviewEl = document.getElementById('under-review');
    const processingEl = document.getElementById('processing');
    const withdrawalsTableEl = document.getElementById('withdrawals-table');
    const selectAllHeader = document.getElementById('selectAllHeader');
    const selectAll = document.getElementById('selectAll');
    const withdrawalDetailsModal = new bootstrap.Modal(document.getElementById('withdrawalDetailsModal'));
    const withdrawalDetailsContent = document.getElementById('withdrawalDetailsContent');
    const approveBtn = document.getElementById('approveBtn');
    const rejectBtn = document.getElementById('rejectBtn');
    const connectionStatusEl = document.getElementById('connectionStatus');

    // Global variables
    let withdrawalsData = [];
    let selectedWithdrawals = new Set();
    let currentWithdrawalId = null;
    let currentPage = 1;
    let itemsPerPage = 10;
    let totalPages = 1;

    // API Base URL
    const API_BASE = window.location.origin;

    // CSRF Token for AJAX requests
    function getCSRFToken() {
        return document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || '';
    }

    // Initialize dashboard
    document.addEventListener('DOMContentLoaded', function() {
        console.log('Initializing Admin Withdrawal Management with Real-time Data...');
        
        // Load initial data
        loadDashboardStats();
        loadWithdrawalsData();
        
        // Set up event listeners
        selectAllHeader.addEventListener('change', toggleSelectAll);
        selectAll.addEventListener('change', toggleSelectAll);
        
        // Set up real-time updates
        setInterval(loadDashboardStats, 30000);
        setInterval(loadWithdrawalsData, 60000);
        
        // Set up connection monitoring
        monitorConnection();
        
        console.log('Admin Withdrawal Management initialized successfully');
    });

    // Load dashboard statistics
    async function loadDashboardStats() {
        try {
            const response = await fetch(`${API_BASE}/api/admin/stats`, {
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'Authorization': `Bearer ${getAuthToken()}`
                }
            });
            
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            
            const data = await response.json();
            
            // Update stats from backend data
            totalPendingEl.textContent = data.pending_withdrawals || 0;
            totalAmountEl.textContent = `KES ${(data.total_pending_amount || 0).toLocaleString()}`;
            underReviewEl.textContent = data.under_review || 0;
            processingEl.textContent = data.processing || 0;
            
            updateConnectionStatus(true);
            
        } catch (error) {
            console.error('Error loading dashboard stats:', error);
            updateConnectionStatus(false);
            // Don't fall back to local data - show zeros
            totalPendingEl.textContent = '0';
            totalAmountEl.textContent = 'KES 0';
            underReviewEl.textContent = '0';
            processingEl.textContent = '0';
        }
    }

    // Load withdrawals data from backend
    async function loadWithdrawalsData() {
        try {
            showLoadingState();
            
            const response = await fetch(`${API_BASE}/admin/withdrawal-notice?page=${currentPage}&limit=${itemsPerPage}`, {
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'Authorization': `Bearer ${getAuthToken()}`
                }
            });
            
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            
            const html = await response.text();
            
            // Parse the HTML response to extract withdrawal data
            await parseWithdrawalsFromHTML(html);
            
            updateConnectionStatus(true);
            
        } catch (error) {
            console.error('Error loading withdrawals data:', error);
            updateConnectionStatus(false);
            showToast('Error loading withdrawal data from server', 'error');
            showErrorState();
        }
    }

    // Parse withdrawals data from HTML response
    async function parseWithdrawalsFromHTML(html) {
        try {
            const parser = new DOMParser();
            const doc = parser.parseFromString(html, 'text/html');
            
            // Extract withdrawal data from the table
            const rows = doc.querySelectorAll('table tbody tr');
            withdrawalsData = [];
            
            rows.forEach(row => {
                const cells = row.querySelectorAll('td');
                if (cells.length >= 8) {
                    const withdrawal = {
                        id: row.dataset.withdrawalId || cells[0]?.querySelector('input')?.value || generateId(),
                        user_id: cells[1]?.querySelector('.user-id')?.value || 'unknown',
                        amount: parseFloat(cells[2]?.textContent.replace('KES', '').replace(/,/g, '').trim()) || 0,
                        transaction_type: 'withdrawal',
                        status: cells[4]?.querySelector('.badge')?.textContent.trim() || 'pending',
                        phone_number: cells[3]?.textContent.trim() || 'N/A',
                        description: cells[2]?.textContent.trim() || 'Withdrawal request',
                        fraud_warnings: row.querySelector('.fraud-warning') ? row.querySelector('.fraud-warning').textContent.trim() : null,
                        created_at: cells[5]?.textContent.trim() || new Date().toISOString(),
                        user: {
                            id: cells[1]?.querySelector('.user-id')?.value || 'unknown',
                            username: cells[1]?.querySelector('.fw-bold')?.textContent.trim() || 'Unknown User',
                            email: cells[1]?.querySelector('.text-muted')?.textContent.trim() || 'No email',
                            phone: cells[3]?.textContent.trim() || 'N/A',
                            balance: 0,
                            total_commission: 0,
                            created_at: new Date().toISOString()
                        }
                    };
                    withdrawalsData.push(withdrawal);
                }
            });
            
            renderWithdrawalsTable();
            updateFraudAlerts();
            
        } catch (error) {
            console.error('Error parsing HTML data:', error);
            showErrorState();
        }
    }

    // Show loading state
    function showLoadingState() {
        withdrawalsTableEl.innerHTML = `
            <tr>
                <td colspan="8" class="text-center py-4">
                    <div class="loading-spinner"></div>
                    Loading withdrawal data...
                </td>
            </tr>
        `;
    }

    // Show error state
    function showErrorState() {
        withdrawalsTableEl.innerHTML = `
            <tr>
                <td colspan="8" class="text-center py-4">
                    <i class="fas fa-exclamation-triangle fa-2x text-warning mb-3"></i>
                    <p class="text-muted">Failed to load withdrawal data from server</p>
                    <button class="btn btn-sm btn-primary" onclick="loadWithdrawalsData()">
                        <i class="fas fa-redo me-2"></i>Retry
                    </button>
                </td>
            </tr>
        `;
        
        // Clear fraud alerts on error
        document.getElementById('suspicious-activity').innerHTML = `
            <div class="alert alert-warning">
                <i class="fas fa-exclamation-triangle me-2"></i>
                Unable to load fraud detection data
            </div>
        `;
        
        document.getElementById('security-events').innerHTML = `
            <div class="alert alert-warning">
                <i class="fas fa-exclamation-triangle me-2"></i>
                Unable to load security events
            </div>
        `;
    }

    // Render withdrawals table with real data
    function renderWithdrawalsTable() {
        if (withdrawalsData.length === 0) {
            withdrawalsTableEl.innerHTML = `
                <tr>
                    <td colspan="8" class="text-center py-4">
                        <i class="fas fa-inbox fa-2x text-muted mb-3"></i>
                        <p class="text-muted">No withdrawal requests found</p>
                    </td>
                </tr>
            `;
            document.getElementById('pagination-container').style.display = 'none';
            return;
        }
        
        withdrawalsTableEl.innerHTML = withdrawalsData.map(withdrawal => `
            <tr data-withdrawal-id="${withdrawal.id}">
                <td>
                    <input type="checkbox" class="bulk-checkbox withdrawal-checkbox" 
                           value="${withdrawal.id}" ${selectedWithdrawals.has(withdrawal.id) ? 'checked' : ''}>
                </td>
                <td>
                    <div class="d-flex align-items-center">
                        <div class="rounded-circle bg-primary text-white d-flex align-items-center justify-content-center me-2" 
                             style="width: 32px; height: 32px; font-size: 0.8rem;">
                            ${withdrawal.user?.username?.charAt(0)?.toUpperCase() || 'U'}
                        </div>
                        <div>
                            <div class="fw-bold">${escapeHtml(withdrawal.user?.username || 'Unknown User')}</div>
                            <small class="text-muted d-block d-md-none">${escapeHtml(withdrawal.phone_number)}</small>
                            <small class="text-muted d-none d-md-block">${escapeHtml(withdrawal.user?.email || 'No email')}</small>
                        </div>
                    </div>
                </td>
                <td class="fw-bold">KES ${Math.abs(withdrawal.amount).toLocaleString()}</td>
                <td class="d-none d-md-table-cell">${escapeHtml(withdrawal.phone_number)}</td>
                <td>
                    <span class="badge ${getStatusBadgeClass(withdrawal.status)}">
                        ${escapeHtml(withdrawal.status)}
                    </span>
                    ${withdrawal.fraud_warnings ? `
                        <div class="fraud-warning mt-1">
                            <i class="fas fa-exclamation-triangle me-1"></i>
                            ${escapeHtml(withdrawal.fraud_warnings)}
                        </div>
                    ` : ''}
                </td>
                <td class="d-none d-md-table-cell">${formatDate(withdrawal.created_at)}</td>
                <td>${calculateDaysPending(withdrawal.created_at)}</td>
                <td>
                    <div class="action-buttons">
                        <button class="btn btn-sm btn-outline-primary" onclick="viewWithdrawalDetails('${withdrawal.id}')" title="View Details">
                            <i class="fas fa-eye"></i>
                            <span class="d-none d-sm-inline">View</span>
                        </button>
                        <button class="btn btn-sm btn-success" onclick="approveWithdrawal('${withdrawal.id}')" 
                                ${!['pending', 'Under Review'].includes(withdrawal.status) ? 'disabled' : ''} title="Approve">
                            <i class="fas fa-check"></i>
                            <span class="d-none d-sm-inline">Approve</span>
                        </button>
                        <button class="btn btn-sm btn-danger" onclick="rejectWithdrawal('${withdrawal.id}')"
                                ${['completed', 'rejected'].includes(withdrawal.status) ? 'disabled' : ''} title="Reject">
                            <i class="fas fa-times"></i>
                            <span class="d-none d-sm-inline">Reject</span>
                        </button>
                    </div>
                </td>
            </tr>
        `).join('');
        
        // Add event listeners to checkboxes
        document.querySelectorAll('.withdrawal-checkbox').forEach(checkbox => {
            checkbox.addEventListener('change', function() {
                const withdrawalId = this.value;
                if (this.checked) {
                    selectedWithdrawals.add(withdrawalId);
                } else {
                    selectedWithdrawals.delete(withdrawalId);
                }
                updateSelectAllState();
            });
        });
        
        // Show pagination if needed
        if (totalPages > 1) {
            document.getElementById('pagination-container').style.display = 'block';
            updatePagination();
        }
    }

    // Format date for display
    function formatDate(dateString) {
        if (!dateString) return 'N/A';
        try {
            const date = new Date(dateString);
            return date.toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'short',
                day: 'numeric'
            });
        } catch (error) {
            return 'Invalid Date';
        }
    }

    // Get status badge class
    function getStatusBadgeClass(status) {
        if (!status) return 'badge-secondary';
        
        const statusLower = status.toLowerCase();
        switch (statusLower) {
            case 'pending': return 'badge-warning';
            case 'under review': return 'badge-danger';
            case 'processing': return 'badge-info';
            case 'completed': return 'badge-success';
            case 'rejected': return 'badge-danger';
            case 'failed': return 'badge-danger';
            default: return 'badge-secondary';
        }
    }

    // Calculate days pending
    function calculateDaysPending(createdAt) {
        if (!createdAt) return 0;
        
        try {
            const created = new Date(createdAt);
            const now = new Date();
            const diffTime = Math.abs(now - created);
            return Math.ceil(diffTime / (1000 * 60 * 60 * 24));
        } catch (error) {
            return 0;
        }
    }

    // Toggle select all
    function toggleSelectAll() {
        const isChecked = selectAllHeader.checked || selectAll.checked;
        document.querySelectorAll('.withdrawal-checkbox').forEach(checkbox => {
            checkbox.checked = isChecked;
            const withdrawalId = checkbox.value;
            if (isChecked) {
                selectedWithdrawals.add(withdrawalId);
            } else {
                selectedWithdrawals.delete(withdrawalId);
            }
        });
        
        // Sync both select all checkboxes
        selectAllHeader.checked = isChecked;
        selectAll.checked = isChecked;
    }

    // Update select all state
    function updateSelectAllState() {
        const checkboxes = document.querySelectorAll('.withdrawal-checkbox');
        const allChecked = checkboxes.length > 0 && Array.from(checkboxes).every(cb => cb.checked);
        selectAllHeader.checked = allChecked;
        selectAll.checked = allChecked;
    }

    // View withdrawal details
    async function viewWithdrawalDetails(withdrawalId) {
        try {
            const withdrawal = withdrawalsData.find(w => w.id === withdrawalId);
            if (!withdrawal) {
                showToast('Withdrawal not found', 'error');
                return;
            }
            
            currentWithdrawalId = withdrawalId;
            
            // Show loading state in modal
            withdrawalDetailsContent.innerHTML = `
                <div class="text-center py-4">
                    <div class="loading-spinner"></div>
                    Loading withdrawal details...
                </div>
            `;
            
            // Fetch additional user details from backend
            let userDetails = withdrawal.user;
            try {
                const response = await fetch(`${API_BASE}/admin/user-details/${withdrawal.user_id}`, {
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest',
                        'Authorization': `Bearer ${getAuthToken()}`
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    if (data.success) {
                        userDetails = data.user;
                    }
                }
            } catch (error) {
                console.error('Error fetching user details:', error);
            }
            
            // Render withdrawal details
            withdrawalDetailsContent.innerHTML = `
                <div class="row">
                    <div class="col-12 col-md-6 mb-3">
                        <div class="user-details-card">
                            <h6>User Information</h6>
                            <p><strong>Username:</strong> ${escapeHtml(userDetails?.username || 'N/A')}</p>
                            <p><strong>Email:</strong> ${escapeHtml(userDetails?.email || 'N/A')}</p>
                            <p><strong>Phone:</strong> ${escapeHtml(userDetails?.phone || 'N/A')}</p>
                            <p><strong>Joined:</strong> ${userDetails?.created_at ? formatDate(userDetails.created_at) : 'N/A'}</p>
                            <p><strong>Balance:</strong> KES ${(userDetails?.balance || 0).toLocaleString()}</p>
                            <p><strong>Total Commission:</strong> KES ${(userDetails?.total_commission || 0).toLocaleString()}</p>
                        </div>
                    </div>
                    <div class="col-12 col-md-6 mb-3">
                        <div class="user-details-card">
                            <h6>Withdrawal Details</h6>
                            <p><strong>Amount:</strong> KES ${Math.abs(withdrawal.amount).toLocaleString()}</p>
                            <p><strong>Phone:</strong> ${escapeHtml(withdrawal.phone_number)}</p>
                            <p><strong>Status:</strong> <span class="badge ${getStatusBadgeClass(withdrawal.status)}">${withdrawal.status}</span></p>
                            <p><strong>Requested:</strong> ${formatDate(withdrawal.created_at)}</p>
                            ${withdrawal.description ? `<p><strong>Description:</strong> ${escapeHtml(withdrawal.description)}</p>` : ''}
                            ${withdrawal.mpesa_code ? `<p><strong>M-Pesa Code:</strong> ${escapeHtml(withdrawal.mpesa_code)}</p>` : ''}
                        </div>
                    </div>
                </div>
                
                ${withdrawal.fraud_warnings ? `
                <div class="fraud-alert mt-3">
                    <h6><i class="fas fa-exclamation-triangle me-2"></i>Fraud Detection Alert</h6>
                    <p class="mb-0">${escapeHtml(withdrawal.fraud_warnings)}</p>
                </div>
                ` : ''}
                
                <div class="mt-3">
                    <h6>Recent Transactions</h6>
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Type</th>
                                    <th>Amount</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${userDetails?.transactions && userDetails.transactions.length > 0 ? 
                                    userDetails.transactions.slice(0, 5).map(t => `
                                        <tr>
                                            <td>${formatDate(t.created_at)}</td>
                                            <td>${escapeHtml(t.transaction_type)}</td>
                                            <td>KES ${Math.abs(t.amount).toLocaleString()}</td>
                                            <td><span class="badge ${getStatusBadgeClass(t.status)}">${escapeHtml(t.status)}</span></td>
                                        </tr>
                                    `).join('') : 
                                    '<tr><td colspan="4" class="text-center">No recent transactions</td></tr>'
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
            
            // Update action buttons state
            const canApprove = ['pending', 'Under Review'].includes(withdrawal.status);
            const canReject = !['completed', 'rejected'].includes(withdrawal.status);
            
            approveBtn.style.display = canApprove ? 'block' : 'none';
            rejectBtn.style.display = canReject ? 'block' : 'none';
            approveBtn.disabled = !canApprove;
            rejectBtn.disabled = !canReject;
            
            // Update action buttons
            approveBtn.onclick = () => approveWithdrawal(withdrawalId);
            rejectBtn.onclick = () => rejectWithdrawal(withdrawalId);
            
            // Show modal
            withdrawalDetailsModal.show();
            
        } catch (error) {
            console.error('Error loading withdrawal details:', error);
            showToast('Error loading withdrawal details', 'error');
        }
    }

    // Approve withdrawal
    async function approveWithdrawal(withdrawalId) {
        const withdrawal = withdrawalsData.find(w => w.id === withdrawalId);
        if (!withdrawal) {
            showToast('Withdrawal not found', 'error');
            return;
        }
        
        showConfirmation(
            'Approve Withdrawal',
            `Are you sure you want to approve this withdrawal of KES ${Math.abs(withdrawal.amount).toLocaleString()}? This will initiate M-Pesa processing.`,
            async () => {
                try {
                    showToast('Processing withdrawal...', 'info');
                    
                    const response = await fetch(`${API_BASE}/admin/approve-withdrawal/${withdrawalId}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': getCSRFToken(),
                            'X-Requested-With': 'XMLHttpRequest'
                        }
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        showToast(result.message, 'success');
                        withdrawalDetailsModal.hide();
                        
                        // Refresh data
                        loadDashboardStats();
                        loadWithdrawalsData();
                    } else {
                        showToast(result.message || 'Approval failed', 'error');
                    }
                    
                } catch (error) {
                    console.error('Error approving withdrawal:', error);
                    showToast('Error approving withdrawal', 'error');
                }
            }
        );
    }

    // Reject withdrawal
    async function rejectWithdrawal(withdrawalId) {
        const withdrawal = withdrawalsData.find(w => w.id === withdrawalId);
        if (!withdrawal) {
            showToast('Withdrawal not found', 'error');
            return;
        }
        
        showConfirmation(
            'Reject Withdrawal',
            `Are you sure you want to reject this withdrawal of KES ${Math.abs(withdrawal.amount).toLocaleString()}? The amount will be refunded to the user's balance.`,
            async () => {
                const reason = prompt('Please enter a reason for rejection:');
                if (!reason) return;
                
                try {
                    showToast('Rejecting withdrawal...', 'info');
                    
                    const response = await fetch(`${API_BASE}/admin/reject-withdrawal/${withdrawalId}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': getCSRFToken(),
                            'X-Requested-With': 'XMLHttpRequest'
                        },
                        body: JSON.stringify({ reason })
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        showToast(result.message, 'success');
                        withdrawalDetailsModal.hide();
                        
                        // Refresh data
                        loadDashboardStats();
                        loadWithdrawalsData();
                    } else {
                        showToast(result.message || 'Rejection failed', 'error');
                    }
                    
                } catch (error) {
                    console.error('Error rejecting withdrawal:', error);
                    showToast('Error rejecting withdrawal', 'error');
                }
            }
        );
    }

    // Bulk actions
    async function bulkApprove() {
        if (selectedWithdrawals.size === 0) {
            showToast('Please select at least one withdrawal to approve', 'warning');
            return;
        }
        
        showConfirmation(
            'Approve Multiple Withdrawals',
            `Are you sure you want to approve ${selectedWithdrawals.size} withdrawal(s)? This will initiate M-Pesa processing for all selected withdrawals.`,
            async () => {
                try {
                    showToast(`Processing ${selectedWithdrawals.size} withdrawals...`, 'info');
                    
                    const response = await fetch(`${API_BASE}/admin/withdrawal-notice/bulk-action`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': getCSRFToken(),
                            'X-Requested-With': 'XMLHttpRequest'
                        },
                        body: JSON.stringify({
                            action: 'approve',
                            transaction_ids: Array.from(selectedWithdrawals)
                        })
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        showToast(result.message, 'success');
                        clearSelection();
                        
                        // Refresh data
                        loadDashboardStats();
                        loadWithdrawalsData();
                    } else {
                        showToast(result.message || 'Bulk approval failed', 'error');
                    }
                    
                } catch (error) {
                    console.error('Error in bulk approve:', error);
                    showToast('Error processing bulk approval', 'error');
                }
            }
        );
    }

    async function bulkReject() {
        if (selectedWithdrawals.size === 0) {
            showToast('Please select at least one withdrawal to reject', 'warning');
            return;
        }
        
        const reason = prompt('Please enter a reason for rejection:');
        if (!reason) return;
        
        showConfirmation(
            'Reject Multiple Withdrawals',
            `Are you sure you want to reject ${selectedWithdrawals.size} withdrawal(s)? The amounts will be refunded to users' balances.`,
            async () => {
                try {
                    showToast(`Rejecting ${selectedWithdrawals.size} withdrawals...`, 'info');
                    
                    const response = await fetch(`${API_BASE}/admin/withdrawal-notice/bulk-action`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': getCSRFToken(),
                            'X-Requested-With': 'XMLHttpRequest'
                        },
                        body: JSON.stringify({
                            action: 'reject',
                            transaction_ids: Array.from(selectedWithdrawals),
                            reason: reason
                        })
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        showToast(result.message, 'success');
                        clearSelection();
                        
                        // Refresh data
                        loadDashboardStats();
                        loadWithdrawalsData();
                    } else {
                        showToast(result.message || 'Bulk rejection failed', 'error');
                    }
                    
                } catch (error) {
                    console.error('Error in bulk reject:', error);
                    showToast('Error processing bulk rejection', 'error');
                }
            }
        );
    }

    async function bulkMarkUnderReview() {
        if (selectedWithdrawals.size === 0) {
            showToast('Please select at least one withdrawal to mark as under review', 'warning');
            return;
        }
        
        showConfirmation(
            'Mark Withdrawals for Review',
            `Are you sure you want to mark ${selectedWithdrawals.size} withdrawal(s) as under review? This will flag them for further investigation.`,
            async () => {
                try {
                    showToast(`Marking ${selectedWithdrawals.size} withdrawals as under review...`, 'info');
                    
                    const response = await fetch(`${API_BASE}/admin/withdrawal-notice/bulk-action`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': getCSRFToken(),
                            'X-Requested-With': 'XMLHttpRequest'
                        },
                        body: JSON.stringify({
                            action: 'review',
                            transaction_ids: Array.from(selectedWithdrawals)
                        })
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        showToast(result.message, 'success');
                        clearSelection();
                        
                        // Refresh data
                        loadDashboardStats();
                        loadWithdrawalsData();
                    } else {
                        showToast(result.message || 'Bulk action failed', 'error');
                    }
                    
                } catch (error) {
                    console.error('Error in bulk mark under review:', error);
                    showToast('Error processing bulk action', 'error');
                }
            }
        );
    }

    function clearSelection() {
        selectedWithdrawals.clear();
        document.querySelectorAll('.withdrawal-checkbox').forEach(cb => cb.checked = false);
        updateSelectAllState();
        showToast('Selection cleared', 'info');
    }

    // Refresh withdrawals
    function refreshWithdrawals() {
        const refreshBtn = document.querySelector('.btn-outline-secondary');
        const originalHTML = refreshBtn.innerHTML;
        refreshBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Refreshing...';
        refreshBtn.disabled = true;
        
        Promise.all([loadDashboardStats(), loadWithdrawalsData()]).finally(() => {
            setTimeout(() => {
                refreshBtn.innerHTML = originalHTML;
                refreshBtn.disabled = false;
            }, 1000);
        });
    }

    // Export withdrawal data
    function exportWithdrawalData() {
        if (withdrawalsData.length === 0) {
            showToast('No data to export', 'warning');
            return;
        }
        
        showToast('Preparing export data...', 'info');
        
        // Create CSV content
        const headers = ['ID', 'Username', 'Amount', 'Phone', 'Status', 'Date', 'Days Pending', 'Fraud Warnings'];
        const csvContent = [
            headers.join(','),
            ...withdrawalsData.map(w => [
                w.id,
                `"${w.user?.username || 'Unknown'}"`,
                Math.abs(w.amount),
                w.phone_number,
                w.status,
                formatDate(w.created_at),
                calculateDaysPending(w.created_at),
                `"${w.fraud_warnings || 'None'}"`
            ].join(','))
        ].join('\n');
        
        // Create and download file
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.setAttribute('hidden', '');
        a.setAttribute('href', url);
        a.setAttribute('download', `withdrawals-${new Date().toISOString().split('T')[0]}.csv`);
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        window.URL.revokeObjectURL(url);
        
        showToast('Export data downloaded successfully!', 'success');
    }

    // Update fraud alerts with real data
    function updateFraudAlerts() {
        const suspiciousActivityEl = document.getElementById('suspicious-activity');
        const securityEventsEl = document.getElementById('security-events');
        
        const suspiciousWithdrawals = withdrawalsData.filter(w => w.fraud_warnings);
        const securityEvents = withdrawalsData
            .filter(w => w.status === 'Under Review')
            .slice(0, 5);
        
        suspiciousActivityEl.innerHTML = suspiciousWithdrawals.length > 0 ? 
            suspiciousWithdrawals.map(w => `
                <div class="alert alert-warning alert-dismissible fade show" role="alert">
                    <strong>${escapeHtml(w.user?.username || 'Unknown User')}</strong> - KES ${Math.abs(w.amount).toLocaleString()}
                    <br><small>${escapeHtml(w.fraud_warnings)}</small>
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `).join('') : 
            '<div class="alert alert-success"><i class="fas fa-check-circle me-2"></i>No suspicious activity detected</div>';
        
        securityEventsEl.innerHTML = securityEvents.length > 0 ?
            securityEvents.map(w => `
                <div class="alert alert-info alert-dismissible fade show" role="alert">
                    <strong>${escapeHtml(w.user?.username || 'Unknown User')}</strong> - Under Review
                    <br><small>KES ${Math.abs(w.amount).toLocaleString()} - ${formatDate(w.created_at)}</small>
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `).join('') :
            '<div class="alert alert-success"><i class="fas fa-check-circle me-2"></i>No security events</div>';
    }

    // Monitor connection
    function monitorConnection() {
        setInterval(async () => {
            try {
                const response = await fetch(`${API_BASE}/health`, {
                    method: 'HEAD',
                    cache: 'no-cache'
                });
                updateConnectionStatus(response.ok);
            } catch (error) {
                updateConnectionStatus(false);
            }
        }, 30000);
    }

    function updateConnectionStatus(connected) {
        if (connected) {
            connectionStatusEl.className = 'connection-status online';
            connectionStatusEl.innerHTML = '<i class="fas fa-wifi"></i><span>Connected</span>';
            connectionStatusEl.style.display = 'flex';
            
            setTimeout(() => {
                connectionStatusEl.style.display = 'none';
            }, 3000);
        } else {
            connectionStatusEl.className = 'connection-status offline';
            connectionStatusEl.innerHTML = '<i class="fas fa-wifi-slash"></i><span>Offline</span>';
            connectionStatusEl.style.display = 'flex';
        }
    }

    // Utility functions
    function escapeHtml(unsafe) {
        if (typeof unsafe !== 'string') return unsafe;
        return unsafe
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;")
            .replace(/"/g, "&quot;")
            .replace(/'/g, "&#039;");
    }

    function generateId() {
        return 'id_' + Math.random().toString(36).substr(2, 9);
    }

    function getAuthToken() {
        // This should be implemented based on your auth system
        return localStorage.getItem('auth_token') || sessionStorage.getItem('auth_token') || '';
    }

    function showConfirmation(title, message, confirmCallback) {
        const confirmationModal = new bootstrap.Modal(document.getElementById('confirmationModal'));
        document.getElementById('confirmationTitle').textContent = title;
        document.getElementById('confirmationMessage').textContent = message;
        
        const confirmBtn = document.getElementById('confirmActionBtn');
        confirmBtn.onclick = function() {
            confirmationModal.hide();
            confirmCallback();
        };
        
        confirmationModal.show();
    }

    function showToast(message, type = 'info') {
        // Create or use existing toast system
        const toastContainer = document.getElementById('toast-container') || createToastContainer();
        
        const toast = document.createElement('div');
        toast.className = `toast align-items-center text-bg-${type} border-0`;
        toast.innerHTML = `
            <div class="d-flex">
                <div class="toast-body">
                    ${message}
                </div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
            </div>
        `;
        
        toastContainer.appendChild(toast);
        const bsToast = new bootstrap.Toast(toast);
        bsToast.show();
        
        toast.addEventListener('hidden.bs.toast', () => {
            toast.remove();
        });
    }

    function createToastContainer() {
        const container = document.createElement('div');
        container.id = 'toast-container';
        container.className = 'toast-container position-fixed top-0 end-0 p-3';
        container.style.zIndex = '9999';
        document.body.appendChild(container);
        return container;
    }

    function updatePagination() {
        const prevPage = document.getElementById('prev-page');
        const nextPage = document.getElementById('next-page');
        
        prevPage.classList.toggle('disabled', currentPage === 1);
        nextPage.classList.toggle('disabled', currentPage === totalPages);
        
        // Update page numbers (simplified)
        const pageItems = document.querySelectorAll('.pagination .page-item:not(:first-child):not(:last-child)');
        pageItems.forEach(item => item.remove());
        
        const pagination = document.querySelector('.pagination');
        const nextItem = document.getElementById('next-page');
        
        for (let i = 1; i <= totalPages; i++) {
            const pageItem = document.createElement('li');
            pageItem.className = `page-item ${i === currentPage ? 'active' : ''}`;
            pageItem.innerHTML = `<a class="page-link" href="#" onclick="goToPage(${i})">${i}</a>`;
            pagination.insertBefore(pageItem, nextItem);
        }
    }

    function goToPage(page) {
        if (page >= 1 && page <= totalPages) {
            currentPage = page;
            loadWithdrawalsData();
        }
    }
</script>
{% endblock %}
