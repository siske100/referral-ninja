{% extends "base.html" %}

{% block title %}Withdrawal Management - Referral Ninja{% endblock %}

{% block content %}
<!-- PROFESSIONAL ADMIN WITHDRAWAL MANAGEMENT DASHBOARD -->
<div class="dashboard-container">
    <!-- Dashboard Header -->
    <div class="dashboard-header">
        <div class="d-flex justify-content-between align-items-center flex-column flex-md-row">
            <div class="text-center text-md-start mb-2 mb-md-0">
                <h1 class="page-title">
                    <i class="fas fa-wallet me-2 text-primary"></i>
                    Withdrawal Management
                </h1>
                <p class="page-subtitle">Monitor, verify, and process withdrawal requests in real-time</p>
            </div>
            <div class="mt-2 mt-md-0">
                <div class="d-flex align-items-center">
                    <div class="form-check form-switch me-3">
                        <input class="form-check-input" type="checkbox" id="live-update-toggle" checked>
                        <label class="form-check-label small text-muted" for="live-update-toggle">Live Updates</label>
                    </div>
                    <button class="btn btn-sm btn-outline-secondary me-2" onclick="refreshWithdrawals()">
                        <i class="fas fa-sync-alt"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-primary" onclick="exportWithdrawalData()">
                        <i class="fas fa-download"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Enhanced Stats Overview -->
    <div class="row g-4 mb-4">
        <div class="col-md-3">
            <div class="stats-card stats-primary">
                <div class="stats-icon">
                    <i class="fas fa-exchange-alt"></i>
                </div>
                <div class="stats-content">
                    <div class="stat-value" id="total-24h">0</div>
                    <div class="stat-label">24h Volume</div>
                    <div class="stats-change text-success" id="change-24h">
                        <i class="fas fa-arrow-up"></i> <span id="change-value">0%</span>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-3">
            <div class="stats-card stats-success">
                <div class="stats-icon">
                    <i class="fas fa-check-circle"></i>
                </div>
                <div class="stats-content">
                    <div class="stat-value" id="successful-24h">0</div>
                    <div class="stat-label">Successful</div>
                    <div class="stats-subtext text-muted" id="success-rate">
                        <span id="success-percentage">0%</span> success rate
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-3">
            <div class="stats-card stats-warning">
                <div class="stats-icon">
                    <i class="fas fa-clock"></i>
                </div>
                <div class="stats-content">
                    <div class="stat-value" id="pending-now">0</div>
                    <div class="stat-label">Pending Review</div>
                    <div class="stats-subtext">
                        <span class="badge bg-warning">Requires Action</span>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-3">
            <div class="stats-card stats-info">
                <div class="stats-icon">
                    <i class="fas fa-chart-line"></i>
                </div>
                <div class="stats-content">
                    <div class="stat-value" id="avg-time">0h</div>
                    <div class="stat-label">Avg. Processing</div>
                    <div class="stats-subtext text-muted" id="avg-amount">
                        KES <span id="avg-withdrawal-amount">0</span> avg.
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Two Column Layout -->
    <div class="row g-4">
        <!-- Left Column: Withdrawals Table -->
        <div class="col-lg-8">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white border-0 py-3">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h5 class="mb-0">Withdrawal Requests</h5>
                            <p class="text-muted small mb-0" id="last-updated">Last updated: Loading...</p>
                        </div>
                        <div class="dropdown">
                            <button class="btn btn-outline-secondary btn-sm dropdown-toggle" type="button" 
                                    data-bs-toggle="dropdown" aria-expanded="false">
                                <i class="fas fa-filter me-1"></i> Filter
                            </button>
                            <ul class="dropdown-menu dropdown-menu-end">
                                <li><a class="dropdown-item" href="#" onclick="filterByStatus('all')">All Status</a></li>
                                <li><hr class="dropdown-divider"></li>
                                <li><a class="dropdown-item" href="#" onclick="filterByStatus('pending')">
                                    <span class="badge bg-warning me-2">●</span>Pending
                                </a></li>
                                <li><a class="dropdown-item" href="#" onclick="filterByStatus('processing')">
                                    <span class="badge bg-info me-2">●</span>Processing
                                </a></li>
                                <li><a class="dropdown-item" href="#" onclick="filterByStatus('completed')">
                                    <span class="badge bg-success me-2">●</span>Completed
                                </a></li>
                                <li><a class="dropdown-item" href="#" onclick="filterByStatus('rejected')">
                                    <span class="badge bg-danger me-2">●</span>Rejected
                                </a></li>
                            </ul>
                        </div>
                    </div>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th>User</th>
                                    <th>Amount</th>
                                    <th>Status</th>
                                    <th class="d-none d-md-table-cell">Verification</th>
                                    <th>Requested</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="withdrawals-table">
                                <tr>
                                    <td colspan="6" class="text-center py-5">
                                        <div class="d-flex justify-content-center">
                                            <div class="spinner-border text-primary" role="status">
                                                <span class="visually-hidden">Loading...</span>
                                            </div>
                                        </div>
                                        <p class="text-muted mt-3">Loading withdrawal requests...</p>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- No Data State -->
                    <div id="no-data-state" class="d-none">
                        <div class="text-center py-5">
                            <div class="mb-3">
                                <i class="fas fa-inbox fa-3x text-muted"></i>
                            </div>
                            <h5 class="text-muted">No Withdrawal Requests</h5>
                            <p class="text-muted">There are no pending withdrawal requests at the moment.</p>
                        </div>
                    </div>
                    
                    <!-- Pagination -->
                    <nav aria-label="Withdrawal pagination" id="pagination-container" class="d-none">
                        <ul class="pagination justify-content-center my-3">
                            <li class="page-item disabled" id="prev-page">
                                <a class="page-link" href="#" tabindex="-1">
                                    <i class="fas fa-chevron-left"></i>
                                </a>
                            </li>
                            <li class="page-item active"><a class="page-link" href="#">1</a></li>
                            <li class="page-item" id="next-page">
                                <a class="page-link" href="#">
                                    <i class="fas fa-chevron-right"></i>
                                </a>
                            </li>
                        </ul>
                    </nav>
                </div>
            </div>

            <!-- Performance Metrics -->
            <div class="card border-0 shadow-sm mt-4">
                <div class="card-header bg-white border-0 py-3">
                    <h5 class="mb-0">Processing Performance</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6 mb-3 mb-md-0">
                            <div class="d-flex align-items-center">
                                <div class="me-3">
                                    <div class="bg-primary text-white rounded-circle d-flex align-items-center justify-content-center" 
                                         style="width: 48px; height: 48px;">
                                        <i class="fas fa-bolt"></i>
                                    </div>
                                </div>
                                <div>
                                    <div class="h4 mb-0" id="avg-processing-time">0h</div>
                                    <div class="text-muted small">Average Processing Time</div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="d-flex align-items-center">
                                <div class="me-3">
                                    <div class="bg-success text-white rounded-circle d-flex align-items-center justify-content-center" 
                                         style="width: 48px; height: 48px;">
                                        <i class="fas fa-percentage"></i>
                                    </div>
                                </div>
                                <div>
                                    <div class="h4 mb-0" id="completion-rate">0%</div>
                                    <div class="text-muted small">Completion Rate (7 days)</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Right Column: Analytics & Alerts -->
        <div class="col-lg-4">
            <!-- Risk Assessment -->
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white border-0 py-3">
                    <h5 class="mb-0">
                        <i class="fas fa-shield-alt text-warning me-2"></i>
                        Risk Assessment
                    </h5>
                </div>
                <div class="card-body">
                    <div id="risk-level" class="text-center mb-4">
                        <div class="d-flex justify-content-center mb-3">
                            <div class="risk-meter">
                                <div class="risk-level low"></div>
                            </div>
                        </div>
                        <h4 class="mb-1">Low Risk</h4>
                        <p class="text-muted small mb-0" id="risk-assessment-text">All transactions appear normal</p>
                    </div>
                    
                    <div class="risk-factors">
                        <div class="d-flex justify-content-between mb-2">
                            <span class="small">Unverified Accounts</span>
                            <span class="small fw-bold text-danger" id="unverified-count">0</span>
                        </div>
                        <div class="d-flex justify-content-between mb-2">
                            <span class="small">High-Frequency Requests</span>
                            <span class="small fw-bold text-warning" id="high-frequency">0</span>
                        </div>
                        <div class="d-flex justify-content-between mb-2">
                            <span class="small">Large Amounts</span>
                            <span class="small fw-bold text-info" id="large-amounts">0</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Recent Activity -->
            <div class="card border-0 shadow-sm mt-4">
                <div class="card-header bg-white border-0 py-3">
                    <h5 class="mb-0">
                        <i class="fas fa-history text-primary me-2"></i>
                        Recent Activity
                    </h5>
                </div>
                <div class="card-body" style="max-height: 300px; overflow-y: auto;">
                    <div id="recent-activity-list">
                        <div class="text-center py-3">
                            <div class="spinner-border spinner-border-sm" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="card border-0 shadow-sm mt-4">
                <div class="card-header bg-white border-0 py-3">
                    <h5 class="mb-0">
                        <i class="fas fa-bolt text-success me-2"></i>
                        Quick Actions
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row g-2">
                        <div class="col-6">
                            <button class="btn btn-outline-primary w-100 py-2" onclick="showPendingWithdrawals()">
                                <i class="fas fa-eye me-1"></i>
                                View Pending
                            </button>
                        </div>
                        <div class="col-6">
                            <button class="btn btn-outline-success w-100 py-2" onclick="exportWithdrawalData()">
                                <i class="fas fa-file-export me-1"></i>
                                Export Data
                            </button>
                        </div>
                    </div>
                    <div class="row g-2 mt-2">
                        <div class="col-6">
                            <button class="btn btn-outline-info w-100 py-2" onclick="viewAnalytics()">
                                <i class="fas fa-chart-bar me-1"></i>
                                Analytics
                            </button>
                        </div>
                        <div class="col-6">
                            <button class="btn btn-outline-warning w-100 py-2" onclick="showFraudDetection()">
                                <i class="fas fa-search me-1"></i>
                                Fraud Scan
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Withdrawal Details Modal -->
<div class="modal fade" id="withdrawalDetailsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header border-0 pb-0">
                <h5 class="modal-title">Withdrawal Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body pt-0">
                <div id="withdrawalDetailsContent">
                    <!-- Content loaded dynamically -->
                </div>
            </div>
            <div class="modal-footer border-0">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-success" id="approveBtn" style="display: none;">
                    <i class="fas fa-check me-1"></i>Approve
                </button>
                <button type="button" class="btn btn-danger" id="rejectBtn" style="display: none;">
                    <i class="fas fa-times me-1"></i>Reject
                </button>
            </div>
        </div>
    </div>
</div>

<!-- User Profile Modal -->
<div class="modal fade" id="userProfileModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header border-0 pb-0">
                <h5 class="modal-title">User Profile</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="user-profile-content">
                    <!-- Content loaded dynamically -->
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Export Options Modal -->
<div class="modal fade" id="exportModal" tabindex="-1">
    <div class="modal-dialog modal-sm">
        <div class="modal-content">
            <div class="modal-header border-0 pb-0">
                <h6 class="modal-title">Export Options</h6>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="list-group list-group-flush">
                    <button class="list-group-item list-group-item-action" onclick="exportData('csv')">
                        <i class="fas fa-file-csv text-primary me-2"></i>
                        CSV Format
                    </button>
                    <button class="list-group-item list-group-item-action" onclick="exportData('excel')">
                        <i class="fas fa-file-excel text-success me-2"></i>
                        Excel Format
                    </button>
                    <button class="list-group-item list-group-item-action" onclick="exportData('pdf')">
                        <i class="fas fa-file-pdf text-danger me-2"></i>
                        PDF Report
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block styles %}
<style>
/* ===== PROFESSIONAL ADMIN DASHBOARD STYLES ===== */
.dashboard-container {
    max-width: 1600px;
    margin: 0 auto;
    padding: 0 15px;
}

/* Header Styles */
.dashboard-header {
    margin-bottom: 2rem;
    padding-bottom: 1.5rem;
    border-bottom: 1px solid #e9ecef;
}

.page-title {
    font-weight: 700;
    color: #2c3e50;
    margin-bottom: 0.5rem;
    font-size: 1.75rem;
}

.page-subtitle {
    color: #6c757d;
    font-size: 1rem;
    font-weight: 400;
}

/* Enhanced Stats Cards */
.stats-card {
    background: white;
    border-radius: 12px;
    padding: 1.5rem;
    box-shadow: 0 2px 8px rgba(0,0,0,0.06);
    transition: all 0.3s ease;
    border: 1px solid #f1f3f4;
    display: flex;
    align-items: center;
    height: 100%;
}

.stats-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 8px 20px rgba(0,0,0,0.1);
    border-color: #e0e0e0;
}

.stats-card.stats-primary {
    border-left: 4px solid #4361ee;
}

.stats-card.stats-success {
    border-left: 4px solid #4cc9f0;
}

.stats-card.stats-warning {
    border-left: 4px solid #f8961e;
}

.stats-card.stats-info {
    border-left: 4px solid #7209b7;
}

.stats-icon {
    width: 48px;
    height: 48px;
    border-radius: 10px;
    background: linear-gradient(135deg, rgba(67, 97, 238, 0.1), rgba(67, 97, 238, 0.05));
    display: flex;
    align-items: center;
    justify-content: center;
    margin-right: 15px;
    font-size: 1.25rem;
    color: #4361ee;
}

.stats-card.stats-success .stats-icon {
    background: linear-gradient(135deg, rgba(76, 201, 240, 0.1), rgba(76, 201, 240, 0.05));
    color: #4cc9f0;
}

.stats-card.stats-warning .stats-icon {
    background: linear-gradient(135deg, rgba(248, 150, 30, 0.1), rgba(248, 150, 30, 0.05));
    color: #f8961e;
}

.stats-card.stats-info .stats-icon {
    background: linear-gradient(135deg, rgba(114, 9, 183, 0.1), rgba(114, 9, 183, 0.05));
    color: #7209b7;
}

.stats-content {
    flex: 1;
}

.stat-value {
    font-size: 1.75rem;
    font-weight: 700;
    color: #2c3e50;
    line-height: 1.2;
    margin-bottom: 0.25rem;
}

.stat-label {
    color: #6c757d;
    font-weight: 500;
    font-size: 0.875rem;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.stats-change {
    font-size: 0.75rem;
    margin-top: 4px;
    font-weight: 600;
}

.stats-subtext {
    font-size: 0.75rem;
    color: #6c757d;
    margin-top: 2px;
}

/* Risk Meter */
.risk-meter {
    width: 120px;
    height: 6px;
    background: #e9ecef;
    border-radius: 3px;
    overflow: hidden;
    position: relative;
}

.risk-level {
    height: 100%;
    position: absolute;
    left: 0;
    border-radius: 3px;
    transition: all 0.3s ease;
}

.risk-level.low {
    width: 30%;
    background: #4cc9f0;
}

.risk-level.medium {
    width: 60%;
    background: #f8961e;
}

.risk-level.high {
    width: 90%;
    background: #f72585;
}

/* Status Badges */
.badge {
    padding: 0.4rem 0.75rem;
    border-radius: 20px;
    font-weight: 600;
    font-size: 0.7rem;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.badge.bg-warning {
    background: rgba(248, 150, 30, 0.1) !important;
    color: #f8961e !important;
    border: 1px solid rgba(248, 150, 30, 0.2);
}

.badge.bg-info {
    background: rgba(67, 97, 238, 0.1) !important;
    color: #4361ee !important;
    border: 1px solid rgba(67, 97, 238, 0.2);
}

.badge.bg-success {
    background: rgba(76, 201, 240, 0.1) !important;
    color: #4cc9f0 !important;
    border: 1px solid rgba(76, 201, 240, 0.2);
}

.badge.bg-danger {
    background: rgba(247, 37, 133, 0.1) !important;
    color: #f72585 !important;
    border: 1px solid rgba(247, 37, 133, 0.2);
}

/* Table Styles */
.table {
    margin-bottom: 0;
}

.table thead th {
    font-weight: 600;
    color: #495057;
    border-bottom: 2px solid #e9ecef;
    background: #f8f9fa;
    font-size: 0.85rem;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    padding: 1rem;
}

.table tbody td {
    padding: 1rem;
    vertical-align: middle;
    border-color: #f1f3f4;
}

.table tbody tr:hover {
    background-color: rgba(67, 97, 238, 0.02);
}

/* User Avatar */
.user-avatar {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    background: linear-gradient(135deg, #4361ee, #3a0ca3);
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 600;
    font-size: 0.875rem;
}

/* Action Buttons */
.action-buttons .btn {
    padding: 0.375rem 0.75rem;
    border-radius: 8px;
    font-size: 0.75rem;
    font-weight: 500;
}

/* Card Styles */
.card {
    border: none;
    border-radius: 12px;
}

.card-header {
    border-bottom: 1px solid #e9ecef;
}

/* Modal Styles */
.modal-content {
    border: none;
    border-radius: 12px;
    box-shadow: 0 10px 40px rgba(0,0,0,0.1);
}

.modal-header {
    padding: 1.5rem 1.5rem 1rem;
}

.modal-body {
    padding: 1rem 1.5rem;
}

.modal-footer {
    padding: 1rem 1.5rem;
}

/* Loading States */
.spinner-border {
    width: 1.5rem;
    height: 1.5rem;
}

/* Recent Activity Items */
.activity-item {
    padding: 0.75rem 0;
    border-bottom: 1px solid #f1f3f4;
}

.activity-item:last-child {
    border-bottom: none;
}

.activity-item .badge {
    width: 8px;
    height: 8px;
    padding: 0;
    border-radius: 50%;
    margin-right: 0.5rem;
}

/* Responsive Design */
@media (max-width: 768px) {
    .stats-card {
        margin-bottom: 1rem;
    }
    
    .stats-icon {
        width: 40px;
        height: 40px;
        font-size: 1rem;
    }
    
    .stat-value {
        font-size: 1.5rem;
    }
    
    .table thead th:nth-child(4),
    .table tbody td:nth-child(4) {
        display: none;
    }
    
    .page-title {
        font-size: 1.5rem;
    }
}

@media (max-width: 576px) {
    .dashboard-header {
        padding-bottom: 1rem;
    }
    
    .stats-card {
        padding: 1rem;
    }
    
    .modal-dialog {
        margin: 0.5rem;
    }
}

/* Animation */
@keyframes fadeIn {
    from {
        opacity: 0;
        transform: translateY(10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.fade-in {
    animation: fadeIn 0.3s ease-out;
}
</style>
{% endblock %}

{% block scripts %}
<script>
// DOM Elements
const withdrawalsTableEl = document.getElementById('withdrawals-table');
const withdrawalDetailsModal = new bootstrap.Modal(document.getElementById('withdrawalDetailsModal'));
const withdrawalDetailsContent = document.getElementById('withdrawalDetailsContent');
const approveBtn = document.getElementById('approveBtn');
const rejectBtn = document.getElementById('rejectBtn');
const lastUpdatedEl = document.getElementById('last-updated');
const liveUpdateToggle = document.getElementById('live-update-toggle');
const noDataState = document.getElementById('no-data-state');
const exportModal = new bootstrap.Modal(document.getElementById('exportModal'));

// Dashboard Stats Elements
const total24hEl = document.getElementById('total-24h');
const successful24hEl = document.getElementById('successful-24h');
const pendingNowEl = document.getElementById('pending-now');
const avgTimeEl = document.getElementById('avg-time');
const changeValueEl = document.getElementById('change-value');
const successPercentageEl = document.getElementById('success-percentage');
const avgWithdrawalAmountEl = document.getElementById('avg-withdrawal-amount');

// Performance Metrics
const avgProcessingTimeEl = document.getElementById('avg-processing-time');
const completionRateEl = document.getElementById('completion-rate');

// Risk Assessment Elements
const riskLevelEl = document.querySelector('.risk-level');
const riskAssessmentText = document.getElementById('risk-assessment-text');
const unverifiedCountEl = document.getElementById('unverified-count');
const highFrequencyEl = document.getElementById('high-frequency');
const largeAmountsEl = document.getElementById('large-amounts');

// Global variables
let withdrawalsData = [];
let currentPage = 1;
let itemsPerPage = 10;
let totalPages = 1;
let liveUpdateInterval;
let currentFilter = 'all';

// API Base URL
const API_BASE = window.location.origin;

// Initialize dashboard
document.addEventListener('DOMContentLoaded', function() {
    console.log('Initializing Professional Withdrawal Management...');
    
    // Load all dashboard components
    Promise.all([
        loadDashboardStats(),
        loadWithdrawalsData(),
        loadRecentActivity(),
        loadRiskAssessment()
    ]).then(() => {
        console.log('Dashboard initialized successfully');
    }).catch(error => {
        console.error('Error initializing dashboard:', error);
    });
    
    // Set up live updates toggle
    liveUpdateToggle.addEventListener('change', function() {
        if (this.checked) {
            startLiveUpdates();
        } else {
            stopLiveUpdates();
        }
    });
    
    // Start live updates
    if (liveUpdateToggle.checked) {
        startLiveUpdates();
    }
    
    // Update last updated time
    updateLastUpdated();
});

// Start live updates
function startLiveUpdates() {
    stopLiveUpdates();
    liveUpdateInterval = setInterval(updateDashboardData, 15000);
    console.log('Live updates started (15s interval)');
}

// Stop live updates
function stopLiveUpdates() {
    if (liveUpdateInterval) {
        clearInterval(liveUpdateInterval);
        console.log('Live updates stopped');
    }
}

// Update dashboard data
async function updateDashboardData() {
    try {
        await Promise.all([
            loadDashboardStats(),
            loadRecentActivity(),
            loadRiskAssessment()
        ]);
        updateLastUpdated();
    } catch (error) {
        console.error('Error updating dashboard data:', error);
    }
}

// Load dashboard statistics
async function loadDashboardStats() {
    try {
        const response = await fetch(`${API_BASE}/api/admin/stats`);
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}`);
        }
        
        const data = await response.json();
        
        // Update main stats
        total24hEl.textContent = data.total_24h?.toLocaleString() || '0';
        successful24hEl.textContent = data.successful_24h?.toLocaleString() || '0';
        pendingNowEl.textContent = data.pending_now?.toLocaleString() || '0';
        avgTimeEl.textContent = `${data.avg_processing_hours || 0}h`;
        
        // Update success rate
        const successRate = data.total_24h > 0 ? 
            Math.round((data.successful_24h / data.total_24h) * 100) : 0;
        successPercentageEl.textContent = `${successRate}%`;
        
        // Update change percentage
        changeValueEl.textContent = `${data.change_24h || 0}%`;
        if (data.change_24h < 0) {
            changeValueEl.parentElement.className = 'stats-change text-danger';
            changeValueEl.parentElement.querySelector('i').className = 'fas fa-arrow-down';
        }
        
        // Update average withdrawal amount
        avgWithdrawalAmountEl.textContent = data.avg_withdrawal?.toLocaleString() || '0';
        
        // Update performance metrics
        avgProcessingTimeEl.textContent = `${data.avg_processing_time || 0}h`;
        completionRateEl.textContent = `${data.completion_rate || 0}%`;
        
    } catch (error) {
        console.error('Error loading dashboard stats:', error);
        showToast('Error loading statistics', 'error');
    }
}

// Load withdrawals data
async function loadWithdrawalsData() {
    try {
        showLoadingState();
        
        const response = await fetch(`${API_BASE}/admin/withdrawal-notice?page=${currentPage}&limit=${itemsPerPage}&filter=${currentFilter}`);
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}`);
        }
        
        const html = await response.text();
        await parseWithdrawalsFromHTML(html);
        
    } catch (error) {
        console.error('Error loading withdrawals data:', error);
        showErrorState();
        showToast('Error loading withdrawal requests', 'error');
    }
}

// Parse withdrawals data from HTML
async function parseWithdrawalsFromHTML(html) {
    try {
        const parser = new DOMParser();
        const doc = parser.parseFromString(html, 'text/html');
        
        const rows = doc.querySelectorAll('table tbody tr');
        withdrawalsData = [];
        
        rows.forEach(row => {
            const cells = row.querySelectorAll('td');
            if (cells.length >= 5) {
                const withdrawal = {
                    id: row.dataset.withdrawalId || generateId(),
                    user_id: row.dataset.userId || generateId(),
                    amount: parseFloat(cells[1]?.textContent.replace('KES', '').replace(/,/g, '').trim()) || 0,
                    status: cells[2]?.querySelector('.badge')?.textContent.trim() || 'pending',
                    phone: cells[3]?.textContent.trim() || 'N/A',
                    verified: cells[3]?.textContent.includes('Verified') || false,
                    created_at: cells[4]?.textContent.trim() || new Date().toISOString(),
                    user: {
                        username: cells[0]?.querySelector('.fw-bold')?.textContent.trim() || 'Unknown',
                        email: cells[0]?.querySelector('.text-muted')?.textContent.trim() || '',
                        avatar: cells[0]?.querySelector('.avatar-initial')?.textContent || 'U'
                    }
                };
                withdrawalsData.push(withdrawal);
            }
        });
        
        renderWithdrawalsTable();
        
    } catch (error) {
        console.error('Error parsing HTML data:', error);
        showErrorState();
    }
}

// Render withdrawals table
function renderWithdrawalsTable() {
    if (withdrawalsData.length === 0) {
        withdrawalsTableEl.classList.add('d-none');
        noDataState.classList.remove('d-none');
        document.getElementById('pagination-container').classList.add('d-none');
        return;
    }
    
    withdrawalsTableEl.classList.remove('d-none');
    noDataState.classList.add('d-none');
    
    withdrawalsTableEl.innerHTML = withdrawalsData.map(withdrawal => {
        const timeAgo = formatTimeAgo(withdrawal.created_at);
        const verifiedBadge = withdrawal.verified ? 
            '<span class="badge bg-success">Verified</span>' : 
            '<span class="badge bg-warning">Unverified</span>';
        
        return `
        <tr data-withdrawal-id="${withdrawal.id}" class="fade-in">
            <td>
                <div class="d-flex align-items-center">
                    <div class="user-avatar me-3">
                        ${withdrawal.user.avatar.toUpperCase()}
                    </div>
                    <div>
                        <div class="fw-medium">${escapeHtml(withdrawal.user.username)}</div>
                        <div class="text-muted small">${escapeHtml(withdrawal.user.email)}</div>
                    </div>
                </div>
            </td>
            <td class="fw-bold">KES ${Math.abs(withdrawal.amount).toLocaleString()}</td>
            <td>
                <span class="badge ${getStatusBadgeClass(withdrawal.status)}">
                    ${escapeHtml(withdrawal.status)}
                </span>
            </td>
            <td class="d-none d-md-table-cell">
                ${verifiedBadge}
            </td>
            <td>
                <small class="text-muted">${timeAgo}</small>
            </td>
            <td>
                <div class="action-buttons d-flex gap-2">
                    <button class="btn btn-sm btn-outline-primary" onclick="viewWithdrawalDetails('${withdrawal.id}')">
                        <i class="fas fa-eye"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-info" onclick="viewUserProfile('${withdrawal.user_id}')">
                        <i class="fas fa-user"></i>
                    </button>
                    ${['pending', 'under review'].includes(withdrawal.status.toLowerCase()) ? `
                    <button class="btn btn-sm btn-success" onclick="approveWithdrawal('${withdrawal.id}')">
                        <i class="fas fa-check"></i>
                    </button>
                    ` : ''}
                </div>
            </td>
        </tr>
        `;
    }).join('');
    
    updatePagination();
}

// View withdrawal details
async function viewWithdrawalDetails(withdrawalId) {
    try {
        const withdrawal = withdrawalsData.find(w => w.id === withdrawalId);
        if (!withdrawal) {
            showToast('Withdrawal not found', 'error');
            return;
        }
        
        withdrawalDetailsContent.innerHTML = `
            <div class="text-center py-4">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
            </div>
        `;
        
        withdrawalDetailsModal.show();
        
        // Simulate API call
        setTimeout(() => {
            withdrawalDetailsContent.innerHTML = `
                <div class="withdrawal-details">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-4">
                                <h6 class="text-muted mb-2">User Information</h6>
                                <div class="d-flex align-items-center mb-3">
                                    <div class="user-avatar me-3">
                                        ${withdrawal.user.avatar.toUpperCase()}
                                    </div>
                                    <div>
                                        <div class="fw-bold">${escapeHtml(withdrawal.user.username)}</div>
                                        <div class="text-muted small">${escapeHtml(withdrawal.user.email)}</div>
                                    </div>
                                </div>
                                <div class="row g-2">
                                    <div class="col-6">
                                        <div class="border rounded p-2">
                                            <div class="small text-muted">Phone Number</div>
                                            <div class="fw-medium">${escapeHtml(withdrawal.phone)}</div>
                                        </div>
                                    </div>
                                    <div class="col-6">
                                        <div class="border rounded p-2">
                                            <div class="small text-muted">Verification</div>
                                            <div>${withdrawal.verified ? 
                                                '<span class="badge bg-success">Verified</span>' : 
                                                '<span class="badge bg-warning">Unverified</span>'}</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-4">
                                <h6 class="text-muted mb-2">Transaction Details</h6>
                                <div class="row g-2">
                                    <div class="col-6">
                                        <div class="border rounded p-2">
                                            <div class="small text-muted">Amount</div>
                                            <div class="fw-bold h5 mb-0">KES ${Math.abs(withdrawal.amount).toLocaleString()}</div>
                                        </div>
                                    </div>
                                    <div class="col-6">
                                        <div class="border rounded p-2">
                                            <div class="small text-muted">Status</div>
                                            <div><span class="badge ${getStatusBadgeClass(withdrawal.status)}">${withdrawal.status}</span></div>
                                        </div>
                                    </div>
                                    <div class="col-6">
                                        <div class="border rounded p-2">
                                            <div class="small text-muted">Requested</div>
                                            <div class="fw-medium">${formatDate(withdrawal.created_at)}</div>
                                        </div>
                                    </div>
                                    <div class="col-6">
                                        <div class="border rounded p-2">
                                            <div class="small text-muted">ID</div>
                                            <div class="small font-monospace">${withdrawal.id}</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    ${withdrawal.status.toLowerCase() === 'pending' ? `
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        This withdrawal requires manual review before processing.
                    </div>
                    ` : ''}
                </div>
            `;
            
            // Show appropriate action buttons
            if (['pending', 'under review'].includes(withdrawal.status.toLowerCase())) {
                approveBtn.style.display = 'inline-block';
                rejectBtn.style.display = 'inline-block';
                
                approveBtn.onclick = () => approveWithdrawal(withdrawal.id);
                rejectBtn.onclick = () => rejectWithdrawal(withdrawal.id);
            } else {
                approveBtn.style.display = 'none';
                rejectBtn.style.display = 'none';
            }
        }, 500);
        
    } catch (error) {
        console.error('Error loading withdrawal details:', error);
        withdrawalDetailsContent.innerHTML = `
            <div class="alert alert-danger">
                <i class="fas fa-exclamation-triangle me-2"></i>
                Error loading withdrawal details. Please try again.
            </div>
        `;
    }
}

// View user profile
async function viewUserProfile(userId) {
    try {
        const modal = new bootstrap.Modal(document.getElementById('userProfileModal'));
        
        // Simulate loading user data
        setTimeout(() => {
            document.getElementById('user-profile-content').innerHTML = `
                <div class="text-center mb-4">
                    <div class="user-avatar mx-auto mb-3" style="width: 60px; height: 60px; font-size: 1.25rem;">
                        U
                    </div>
                    <h5 class="mb-1">John Doe</h5>
                    <p class="text-muted small mb-0">john@example.com</p>
                    <span class="badge bg-success mt-2">Verified Account</span>
                </div>
                
                <div class="row g-3">
                    <div class="col-6">
                        <div class="text-center">
                            <div class="h4 mb-0">KES 45,000</div>
                            <div class="text-muted small">Total Withdrawn</div>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="text-center">
                            <div class="h4 mb-0">12</div>
                            <div class="text-muted small">Total Requests</div>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="text-center">
                            <div class="h4 mb-0">94%</div>
                            <div class="text-muted small">Success Rate</div>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="text-center">
                            <div class="h4 mb-0">6 mo</div>
                            <div class="text-muted small">Member For</div>
                        </div>
                    </div>
                </div>
            `;
            
            modal.show();
        }, 300);
        
    } catch (error) {
        console.error('Error loading user profile:', error);
        showToast('Error loading user profile', 'error');
    }
}

// Load recent activity
async function loadRecentActivity() {
    try {
        const response = await fetch(`${API_BASE}/api/admin/recent-activity`);
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}`);
        }
        
        const data = await response.json();
        const container = document.getElementById('recent-activity-list');
        
        if (data.activities && data.activities.length > 0) {
            container.innerHTML = data.activities.map(activity => `
                <div class="activity-item">
                    <div class="d-flex justify-content-between align-items-start">
                        <div class="flex-grow-1">
                            <div class="fw-medium small">${escapeHtml(activity.user)}</div>
                            <div class="text-muted smaller">${escapeHtml(activity.action)}</div>
                        </div>
                        <div class="text-end">
                            <div class="text-muted smaller">${activity.time_ago}</div>
                            <span class="badge ${getStatusBadgeClass(activity.status)}">${activity.status}</span>
                        </div>
                    </div>
                </div>
            `).join('');
        } else {
            container.innerHTML = `
                <div class="text-center py-4">
                    <i class="fas fa-history fa-lg text-muted mb-3"></i>
                    <p class="text-muted small mb-0">No recent activity</p>
                </div>
            `;
        }
        
    } catch (error) {
        console.error('Error loading recent activity:', error);
    }
}

// Load risk assessment
async function loadRiskAssessment() {
    try {
        const response = await fetch(`${API_BASE}/api/admin/risk-assessment`);
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}`);
        }
        
        const data = await response.json();
        
        // Update risk level
        if (data.risk_level === 'low') {
            riskLevelEl.className = 'risk-level low';
            riskAssessmentText.textContent = 'All transactions appear normal';
        } else if (data.risk_level === 'medium') {
            riskLevelEl.className = 'risk-level medium';
            riskAssessmentText.textContent = 'Some transactions require review';
        } else {
            riskLevelEl.className = 'risk-level high';
            riskAssessmentText.textContent = 'High risk - Immediate review needed';
        }
        
        // Update risk factors
        unverifiedCountEl.textContent = data.unverified_count || 0;
        highFrequencyEl.textContent = data.high_frequency || 0;
        largeAmountsEl.textContent = data.large_amounts || 0;
        
    } catch (error) {
        console.error('Error loading risk assessment:', error);
    }
}

// Filter by status
function filterByStatus(status) {
    currentFilter = status;
    currentPage = 1;
    loadWithdrawalsData();
    
    // Update UI to show active filter
    const dropdownItems = document.querySelectorAll('.dropdown-item');
    dropdownItems.forEach(item => {
        item.classList.remove('active');
    });
    
    const activeItem = Array.from(dropdownItems).find(item => 
        item.getAttribute('onclick')?.includes(`'${status}'`)
    );
    
    if (activeItem) {
        activeItem.classList.add('active');
    }
}

// Show pending withdrawals
function showPendingWithdrawals() {
    filterByStatus('pending');
}

// View analytics
function viewAnalytics() {
    showToast('Analytics dashboard coming soon', 'info');
}

// Show fraud detection
function showFraudDetection() {
    showToast('Fraud detection scan initiated', 'info');
}

// Approve withdrawal
async function approveWithdrawal(withdrawalId) {
    if (!confirm('Are you sure you want to approve this withdrawal?')) {
        return;
    }
    
    try {
        showToast('Processing withdrawal approval...', 'info');
        
        // Simulate API call
        setTimeout(() => {
            showToast('Withdrawal approved successfully', 'success');
            withdrawalDetailsModal.hide();
            loadWithdrawalsData();
            loadDashboardStats();
        }, 1000);
        
    } catch (error) {
        console.error('Error approving withdrawal:', error);
        showToast('Error approving withdrawal', 'error');
    }
}

// Reject withdrawal
async function rejectWithdrawal(withdrawalId) {
    const reason = prompt('Please provide a reason for rejection:');
    if (!reason) return;
    
    try {
        showToast('Processing withdrawal rejection...', 'info');
        
        // Simulate API call
        setTimeout(() => {
            showToast('Withdrawal rejected successfully', 'success');
            withdrawalDetailsModal.hide();
            loadWithdrawalsData();
            loadDashboardStats();
        }, 1000);
        
    } catch (error) {
        console.error('Error rejecting withdrawal:', error);
        showToast('Error rejecting withdrawal', 'error');
    }
}

// Refresh withdrawals
async function refreshWithdrawals() {
    const refreshBtn = document.querySelector('.btn-outline-secondary');
    const originalHTML = refreshBtn.innerHTML;
    
    refreshBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
    refreshBtn.disabled = true;
    
    await Promise.all([
        loadDashboardStats(),
        loadWithdrawalsData(),
        loadRecentActivity(),
        loadRiskAssessment()
    ]);
    
    showToast('Data refreshed successfully', 'success');
    
    setTimeout(() => {
        refreshBtn.innerHTML = originalHTML;
        refreshBtn.disabled = false;
    }, 500);
}

// Export data
function exportWithdrawalData() {
    exportModal.show();
}

function exportData(format) {
    showToast(`Exporting data in ${format.toUpperCase()} format...`, 'info');
    exportModal.hide();
    
    // Simulate export
    setTimeout(() => {
        showToast('Export completed successfully', 'success');
    }, 2000);
}

// Show loading state
function showLoadingState() {
    withdrawalsTableEl.innerHTML = `
        <tr>
            <td colspan="6" class="text-center py-5">
                <div class="d-flex justify-content-center">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
                <p class="text-muted mt-3">Loading withdrawal requests...</p>
            </td>
        </tr>
    `;
}

// Show error state
function showErrorState() {
    withdrawalsTableEl.innerHTML = `
        <tr>
            <td colspan="6" class="text-center py-5">
                <div class="mb-3">
                    <i class="fas fa-exclamation-triangle fa-2x text-warning"></i>
                </div>
                <h5 class="text-muted">Unable to Load Data</h5>
                <p class="text-muted mb-3">Please check your connection and try again.</p>
                <button class="btn btn-primary btn-sm" onclick="loadWithdrawalsData()">
                    <i class="fas fa-redo me-1"></i> Retry
                </button>
            </td>
        </tr>
    `;
}

// Update pagination
function updatePagination() {
    // Simplified pagination logic
    // Implement based on your backend response
}

// Update last updated time
function updateLastUpdated() {
    const now = new Date();
    lastUpdatedEl.textContent = `Last updated: ${now.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}`;
}

// Format time ago
function formatTimeAgo(dateString) {
    const date = new Date(dateString);
    const now = new Date();
    const diffMs = now - date;
    const diffMins = Math.floor(diffMs / 60000);
    
    if (diffMins < 1) return 'Just now';
    if (diffMins < 60) return `${diffMins}m ago`;
    
    const diffHours = Math.floor(diffMins / 60);
    if (diffHours < 24) return `${diffHours}h ago`;
    
    const diffDays = Math.floor(diffHours / 24);
    if (diffDays < 7) return `${diffDays}d ago`;
    
    return formatDate(dateString);
}

// Format date
function formatDate(dateString) {
    const date = new Date(dateString);
    return date.toLocaleDateString('en-US', {
        month: 'short',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
    });
}

// Get status badge class
function getStatusBadgeClass(status) {
    const statusLower = status.toLowerCase();
    switch (statusLower) {
        case 'pending': return 'bg-warning';
        case 'under review': return 'bg-info';
        case 'processing': return 'bg-primary';
        case 'completed': return 'bg-success';
        case 'rejected': return 'bg-danger';
        default: return 'bg-secondary';
    }
}

// Show toast notification
function showToast(message, type = 'info') {
    const toast = document.createElement('div');
    toast.className = `toast align-items-center text-white bg-${type} border-0`;
    toast.innerHTML = `
        <div class="d-flex">
            <div class="toast-body">${message}</div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>
    `;
    
    const container = document.getElementById('toast-container') || createToastContainer();
    container.appendChild(toast);
    
    const bsToast = new bootstrap.Toast(toast);
    bsToast.show();
    
    setTimeout(() => toast.remove(), 3000);
}

function createToastContainer() {
    const container = document.createElement('div');
    container.id = 'toast-container';
    container.className = 'toast-container position-fixed top-0 end-0 p-3';
    container.style.zIndex = '9999';
    document.body.appendChild(container);
    return container;
}

// Utility functions
function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function generateId() {
    return Math.random().toString(36).substr(2, 9);
}
</script>
{% endblock %}
